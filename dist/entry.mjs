var Y=class{constructor(e){this.Instruments=e.Instruments,this.KeySignature=e.KeySignature,this.Measures=e.Measures,this.Pages=e.Pages}};var A=class{constructor(e){this.Num=e,this.Buffer=this.Num*1e3,this.TopLine=5,this.BotLine=35,this.MidLine=15}};function Be(n,e,t,i){let{context:s,camera:o}=n,a=t?4:2,f=2,r=e.Staves,u=N(r,r.length-1)+41,l=e.Bounds.y+(E(r,0)-4)*5;s.fillStyle=i.LineColour;let m=`M${e.Bounds.x+o.x} 
        ${l+o.y} h 
        ${f} v ${u} h -${f} Z`,d=`M${e.Bounds.x+e.Bounds.width+e.XOffset+o.x} 
        ${l+o.y} h 
        ${a} v ${u} h -${a} Z`,h=`M${e.Bounds.x+e.Bounds.width+e.XOffset+o.x-3} 
        ${l+o.y} h 
        ${f} v ${u} h -${f} Z`;s.fill(new Path2D(m)),s.fill(new Path2D(d)),t&&s.fill(new Path2D(h))}function N(n,e=-1){let t=0;return n.forEach((i,s)=>{if(s<e||e===-1){let a=i.TopLine<0?i.BotLine+Math.abs(i.TopLine):i.BotLine-i.TopLine;t+=a*5}}),t}function pe(n,e){let t=n.find(o=>o.Num===e);return t?(t.TopLine<0?t.BotLine+Math.abs(t.TopLine):t.BotLine-t.TopLine)*5:(console.error("Cannot find staff: ",e),-1)}function E(n,e){let i=n.find(s=>s.Num===e);return 0+(i.MidLine-i.TopLine)}function Te(n,e){let t=N(n,e)/5,i=n.find(s=>s.Num===e);return t+(i.MidLine-i.TopLine)}function Le(n,e,t){let{canvas:i,context:s,camera:o}=n,a=10,f=1,r=2,u=e.Staves,l=e.Bounds.y+N(u,t.Num),m=E(u,t.Num),d=N(u,u.length-2)+(E(u,u.length-1)-2)*5;for(let h=0;h<5;h++){let c=`M${e.Bounds.x+o.x} 
    ${l+5*m-a*2+a*h+o.y} h 
    ${e.Bounds.width+e.XOffset} v ${f} h -${e.Bounds.width+e.XOffset} Z`,S=new Path2D(c);s.fill(S)}}var Z=class{constructor(e){this.Selected=!1;this.Editable=!1;this.Bounds=e}IsHovered(e,t,i){return this.Bounds.IsHovered(e,t,i)}Render(e,t,i){e.fillStyle=i.NoteElements,e.fillRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height)}};var z=new Map([[1,1],[.5,.5],[.25,.25],[.125,.125],[.0625,.0625],[.03125,.03125]]);function W(n){let e=n,t=[];for(n%.03125===0||console.error("Not divisible by standard value, not implemented"),z.has(n)&&(t.push(n),e-=n,e!==0&&console.error("HUH?"));e>0;){for(let[s,o]of z)z.get(s)<=e&&(t.push(z.get(s)),e-=z.get(s));e<.03125&&(e=0)}return t}var p=class{constructor(e,t,i,s){this.x=e,this.y=t,this.width=i,this.height=s}IsHovered(e,t,i){return e>=this.x+i.x&&e<=this.x+i.x+this.width&&t>=this.y+i.y&&t<=this.y+i.y+this.height}};var ut=42;function v(n,e,t,i,s,o){let{canvas:a,context:f,camera:r}=n;f.fillStyle=o?s.SelectColour:s.NoteElements,f.font=`${ut}px Bravura`,f.fillText(e,t+r.x,i+r.y)}var lt="c-.2863.1212-.4577.5392-.326.8318.0397.0418.4556.5392.8736 1.0868.9551 1.0764 1.1182 1.3313 1.3292 1.8288.8339 1.7054.3762 3.877-1.0847 5.2501-.1233.163-.6625.6186-1.1683.9948-1.4525 1.2498-2.1214 1.9604-2.368 2.5874-.0899.1651-.0899.3281-.0899.581-.0397.5789 0 .6291 1.7159 2.6209 2.3262 2.7922 3.9919 4.7506 4.1215 4.8739l.1233.1212-.163-.0815c-2.2948-.9551-4.8739-1.4128-5.7475-.9948-.2947.1212-.4661.2926-.5873.5789-.3365.7106-.2466 1.7556.2529 3.2897.4556 1.3794 1.371 3.2082 2.2844 4.5813.3762.5873 1.0868 1.5006 1.1683 1.5424.1233.1233.2947.0815.4159 0 .1233-.163.1233-.2947-.1212-.5789-.8736-1.2498-1.2895-3.8372-.7921-5.2104.2027-.6186.4577-.9551.9133-1.1662 1.208-.5392 3.879.1296 4.9972 1.2477.0815.0836.2529.255.3344.2947.2947.1233.7106-.0397.8339-.3344.1714-.2947.0815-.4974-.2947-.9551-.7022-.8339-2.8257-3.3315-3.1183-3.7077-.7524-.8736-1.0868-1.7054-1.1683-2.7504-.0397-1.3313.4974-2.7421 1.5027-3.6659.1212-.163.6604-.6207 1.16-.9948 1.5424-1.2916 2.1715-2.0001 2.416-2.671.1714-.5392.0899-1.0366-.2863-1.4943-.1296-.1212-1.5842-1.9186-3.2897-3.9585-2.3345-2.7442-3.1684-3.7474-3.2897-3.7892-.1714-.0397-.3762-.0397-.5476.0418z",mt="c-.884.1666-1.5606.7769-1.8666 1.6201-.0663.272-.0663.3383-.0663.7106 0 .5117.0323.7837.272 1.1883.3383.6783 1.0489 1.2223 1.8598 1.4212.85.2397 2.2712.034 3.8981-.5049l.4046-.1394-1.9992 5.525-1.9652 5.5182c0 0 .0663.034.1734.1071.1989.1326.5372.2329.7769.2329.4046 0 .9163-.2329.9826-.4386 0-.0663.9486-3.2878 2.0978-7.1128l2.0315-7.0125-.0663-.0986c-.1649-.2057-.5032-.272-.7106-.1071-.0663.0663-.1717.2057-.238.306-.306.5117-1.0829 1.4212-1.4875 1.7595-.3723.306-.578.3383-.9163.2057-.306-.1666-.4063-.3383-.612-1.2546-.1989-.9095-.4369-1.3226-.9486-1.6609-.4726-.3043-1.0829-.4046-1.6201-.2652z",dt="c-.6228.1176-1.1016.5484-1.3116 1.1436-.0516.192-.0516.2388-.0516.5016 0 .3612.0228.5532.192.8388.2388.4788.7404.8628 1.3176 1.0032.5952.1692 1.5504.0468 2.7-.3324.168-.0708.3084-.1224.3084-.0984 0 .0276-1.0728 3.516-1.1196 3.6372-.1224.3096-.5304.882-.8868 1.242-.3324.3336-.5016.408-.7632.2868-.216-.1176-.2868-.24-.432-.8868-.1212-.4776-.2148-.7404-.4068-.9276-.5016-.5532-1.3644-.624-2.0304-.192-.3144.2148-.5532.5484-.6936.9096-.0516.1872-.0516.2388-.0516.5004 0 .3564.0276.5496.192.8352.2388.4776.7404.8628 1.3176 1.0032.2628.0744.9324.0744 1.3872 0 .3792-.0708.834-.1884 1.2888-.3336.192-.0696.3612-.1164.3612-.0936 0 0-2.3436 7.6272-2.3904 7.7436 0 .024.1872.1692.3792.216.192.0756.3852.0756.5772 0 .1872-.0468.3792-.1644.3792-.2388.024-.024.9804-3.6324 2.1516-8.0112l2.1288-7.9596-.0468-.0696c-.0948-.1452-.2868-.1692-.4548-.0984-.0948.0468-.0948.0468-.3804.4776-.2388.384-.576.7872-.768.9792-.2628.216-.4032.2628-.6432.1692-.2148-.1176-.2904-.2388-.4308-.8856-.1452-.642-.3144-.9336-.6708-1.1724-.3324-.2148-.7632-.2856-1.1484-.1872z",ht="m0 0c-.516.101-.918.461-1.094.957-.043.16-.043.199-.043.418 0 .218 0 .3.043.418.137.441.418.777.856.976.297.16.437.18.855.18.52 0 .957-.078 1.657-.297.179-.063.316-.102.316-.102.019 0-.16.7-.399 1.536-.296 1.175-.417 1.554-.457 1.671-.16.301-.5.758-.718.957-.2.18-.317.219-.516.141-.18-.098-.242-.199-.359-.738-.102-.399-.18-.617-.34-.778-.418-.457-1.137-.515-1.692-.156-.261.176-.46.457-.578.754-.043.16-.043.199-.043.418 0 .301.024.461.161.699.199.399.617.719 1.097.836.219.063.778.063 1.156 0 .317-.058.696-.16 1.075-.277.179-.059.32-.102.32-.102 0 .02-.797 3.051-.84 3.11-.156.34-.476.758-.715.996-.258.258-.398.301-.617.219-.18-.098-.242-.2-.359-.739-.102-.398-.18-.617-.34-.773-.418-.461-1.137-.52-1.692-.16-.261.179-.46.457-.578.758-.043.156-.043.199-.043.417 0 .219 0 .297.043.418.137.438.418.778.856.977.32.16.437.18.875.18.32 0 .422 0 .679-.043.36-.059.739-.176 1.157-.297l.258-.102v.063c-.02.078-1.696 6.375-1.715 6.414-.02.082.34.238.558.238.219 0 .539-.137.559-.238.019-.02.976-4.145 2.172-9.164 2.133-9.086 2.133-9.106 2.094-9.168-.063-.078-.161-.117-.282-.117-.14.019-.199.078-.34.316-.277.481-.597.898-.773 1.039-.121.078-.223.078-.379.02-.18-.102-.242-.2-.359-.739-.121-.539-.262-.777-.559-.976-.277-.18-.637-.238-.957-.16z";var G=9;function ue(n,e,t,i,s,o,a,f="black"){let{x:r,y:u,width:l,height:m}=t,{canvas:d,context:h,camera:c}=e,S=s?o===0?11:-11:0,g=`m ${r+c.x} ${u+7.5-1+c.y}`;u=u+3,f=n.Editable?a.NoteElements:a.UneditableColour,f=i?a.SelectColour:f;let b="";switch(n.Duration){case .125:case .25:v(e,"\uE0A4",r,u,a,i);break;case .5:v(e,"\uE0A3",r,u,a,i);break;case 1:v(e,"\uE0A2",r-2.5,u,a,i);break;default:v(e,"\uE0A4",r,u,a,i)}h.fillStyle=a.NoteElements,i&&(h.fillStyle=a.SelectColour),!1&&(h.fillStyle="rgba(200, 0, 0, 0.5)",h.fillRect(r+c.x,u+c.y-5,l,m),h.fillStyle=a.NoteElements)}function Ce(n,e,t){let{canvas:i,context:s,camera:o}=n,a=0;switch(e.Duration){case .046875:case .09375:case .1875:case .375:case .75:case 1.5:a=1;break;case .0546875:case .109375:case .21875:case .4375:case .875:case 1.75:a=2;break;case .05859375:case .1171875:case .234375:case .46875:case .9375:case 1.875:a=3;break;default:a=0}let f="a1.485 1.485 90 10-2.97 0 1.485 1.485 90 102.97 0";for(let r=0;r<a;r++){let u=e.Line*5;e.Line%2!==0&&(u=(e.Line-1)*5);let l=`m${t+o.x+17+r*5} 
      ${u+o.y}`+f;s.fill(new Path2D(l))}}function _(n,e,t,i,s,o){n.fillStyle=o.NoteElements;let a=e.Bounds.x+t.x+G,f=s.GetNotePositionOnLine(i.Line+2.5,i.Staff)+t.y,r=`m${a} ${f}`;n.fillStyle=i.Selected?o.SelectColour:o.NoteElements,e.Duration===.3125?(f+=7,r=`m ${a} ${f}`+ht,n.fill(new Path2D(r))):e.Duration===.0625?(f+=9,r=`m ${a} ${f}`+dt,n.fill(new Path2D(r))):e.Duration>.0625&&e.Duration<=.125?(f=f+10,r=`m${a} ${f}`+mt,n.fill(new Path2D(r))):e.Duration===.25?(r=r+lt,n.fill(new Path2D(r))):e.Duration===.5?(f=s.GetNotePositionOnLine(i.Line+4.5,i.Staff)+t.y,n.fillRect(a,f,14,6)):e.Duration===1&&(f=s.GetNotePositionOnLine(i.Line+3.6,i.Staff)+t.y,a=e.Bounds.x+t.x+e.Bounds.width/2-7,n.fillRect(a,f,14,6))}function St(n,e,t,i){let{canvas:s,context:o,camera:a}=n,f=e.x2-e.x1;o.fillStyle="#75757",o.fillRect(e.x1+a.x,e.y1-12+a.y,1,6),o.fillRect(e.x1+a.x,e.y1-12+a.y,f/2-14,1),o.fillRect(e.x1+f+a.x,e.y1-12+a.y,1,6),o.fillRect(e.x1+f/2+14+a.x,e.y1-12+a.y,f/2-14,1),v(n,ct(t),e.x1+f/2-7,e.y1-5,i,!1)}function ct(n){switch(n){case"0":return"\uE880";case"1":return"\uE881";case"2":return"\uE882";case"3":return"\uE883";case"4":return"\uE884";case"5":return"\uE885";case"6":return"\uE886";case"7":return"\uE887";case"8":return"\uE888";case"9":return"\uE889";default:return"\uE883"}}function le(n,e,t,i,s,o){let{canvas:a,context:f,camera:r}=n,u=e.filter(S=>S.Staff===i);u.sort((S,g)=>S.Beat-g.Beat);let l=!1,m=0,d=0,h=0,c=0;u.forEach((S,g)=>{let b=t.filter(L=>L.Beat===S.Beat&&L.Staff===i),T=[...b],D=O([b],[S],i,s);if(!b[0].Tuple){l&&(l=!1,St(n,{x1:m,y1:h,x2:d,y2:h},c.toString(),o),m=0,d=0,h=0,c=0);return}l||(l=!0,m=S.Bounds.x+9,c=b[0].TupleDetails.Count,h=S.Bounds.y),d=S.Bounds.x+19})}function me(n,e,t,i,s){let{canvas:o,context:a,camera:f}=n,r=e.filter(u=>u.Staff===i);r.sort((u,l)=>u.Beat-l.Beat),r.forEach((u,l)=>{if(l===r.length-1)return;let m=t.filter(h=>h.Beat===u.Beat);m.sort((h,c)=>h.Line-c.Line);let d=t.filter(h=>h.Beat===r[l+1].Beat);d.sort((h,c)=>h.Line-c.Line),m.forEach(h=>{if(!h.Tied||h.Rest||h.Tied&&h.Beat+h.Duration*s.TimeSignature.bottom>h.TiedEnd)return;let c=d.find(B=>B.Line===h.Line&&B.Tied&&B.Beat<=B.TiedEnd);if(c===void 0){console.error("No tied note found: ",h);return}let S=c,g=u.Bounds.x+G+f.x,b=s.GetNotePositionOnLine(h.Line,h.Staff)+f.y,T=r[l+1].Bounds.x+G+f.x,D=s.GetNotePositionOnLine(S.Line,h.Staff)+f.y,L=h.Line<15?-15:15,I=h.Line<15?-8:8;a.fillStyle="#757575",a.strokeStyle="#757575",a.setLineDash([]),a.beginPath(),a.moveTo(g+G/2,b+I),a.quadraticCurveTo(g+G/2+(T-g)/2,b+L,T+G/2,D+I),a.stroke()})})}function O(n,e,t,i){let s=0;n.sort((u,l)=>u[0].Beat-l[0].Beat);let o=!0;if(e.forEach((u,l)=>{u.Beat!==n[l][0].Beat&&(console.error("Index: ",l),console.error("Match failed on div: ",u),console.error("Match failed on beat: ",u.Beat),console.error("Match fail note: ",n[l][0]),o=!1)}),!o){console.error("Divisions and note array do not match");return}let a=15,f=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER;return n.forEach(u=>{u.forEach(l=>{l.Line<f&&(f=l.Line),l.Line>r&&(r=l.Line)})}),a-f<r-a?s=0:s=1,s}function de(n,e,t,i,s,o,a){let{canvas:f,context:r,camera:u}=t,l=G,d=s.Notes.filter(D=>D.Beat===e.Beat&&D.Staff===e.Staff).filter(D=>D.Accidental!==0).length;d>0&&(l+=G*d-1);let h=e.Bounds.x+l-6+u.x,c="h 22 v 1.5 h-20 v-1.5 Z",S=n.filter(D=>D.Beat===e.Beat&&D.Staff===e.Staff),g=15;if(S.length===0)return;S.sort((D,L)=>D.Line-L.Line);let b=S[0],T=S[S.length-1];r.fillStyle=o.NoteElements;for(let D=g-6;D>=b.Line;D-=2){let L=s.GetNotePositionOnLine(D,i)+u.y+2.5,I=`m ${h} ${L}`+c;r.fill(new Path2D(I))}for(let D=g+6;D<=T.Line;D+=2){let L=s.GetNotePositionOnLine(D,i)+u.y+2.5,I=`m ${h} ${L}`+c;r.fill(new Path2D(I))}}var X=class{constructor(e,t,i){this.Bounds=e,this.StartPoint=t,this.EndPoint=i}Render(e,t,i,s,o){e.fillStyle=o.NoteElements;let a=6,f=`M ${this.StartPoint.x+t.x} ${this.StartPoint.y+t.y}
        L${this.EndPoint.x+t.x+2} ${this.EndPoint.y+t.y}
        V${this.EndPoint.y+t.y+a} 
        L${this.StartPoint.x+t.x} ${this.StartPoint.y+a+t.y} z `;e.fill(new Path2D(f));let r=s===0?2.5:-8,u=s===0?6:0;for(let l=1;l<i;l++){let d=`M ${this.StartPoint.x+t.x} ${this.StartPoint.y+u*l+r*l+t.y}
          L${this.EndPoint.x+t.x+2} ${this.EndPoint.y+u*l+r*l+t.y}
          V${this.EndPoint.y+u*l+r*l+t.y+6} 
          L${this.StartPoint.x+t.x} ${this.StartPoint.y+u*l+r*l+6+t.y} z`;e.fill(new Path2D(d))}}};function q(n,e,t){let i=e.Divisions.sort((s,o)=>s.Beat-o.Beat);if(t===0){let s=e.Notes[0].sort((a,f)=>a.Line-f.Line)[0].Line,o=e.Notes[e.Notes.length-1].sort((a,f)=>a.Line-f.Line)[0].Line;if(s===o)return 4;if(s<o)return 2;if(s>o)return 0}else{let s=e.Notes[0].sort((a,f)=>a.Line-f.Line)[e.Notes[0].length-1].Line,o=e.Notes[e.Notes.length-1].sort((a,f)=>a.Line-f.Line)[e.Notes[e.Notes.length-1].length-1].Line;if(s===o)return 4;if(s<o)return 0;if(s>o)return 2}return 4}var F=class{constructor(e,t,i,s){this.ID=e,this.Position={x:0,y:0},this.Staff=s,this.Bounds=new p(0,0,0,0),this.Type=t,this.SelType=2,this.Beat=i,this.Selected=!1,this.Editable=!0}render(e,t){let i;switch(this.Type){case"treble":i="\u{1D11E}";break;case"bass":i="\u{1D122}";break;default:i="\u{1D11E}"}v(e,i,this.Position.x,this.Position.y,t,this.Selected)}SetBounds(e,t){let i=e.Divisions.find(u=>u.Beat===this.Beat&&u.Staff===t),s=this.Beat===1?e.Bounds.x:i.Bounds.x,o=3,a=2,f=0,r=10;switch(this.Position.x=s+o,this.Bounds.x=s+o,this.Type){case"bass":a=-2}this.Position.y=i.Bounds.y+f+(r+a)*5,this.Bounds.y=i.Bounds.y,this.Bounds.width=30,this.Bounds.height=85}IsHovered(e,t,i){return this.Bounds.IsHovered(e,t,i)}};function P(n,e,t){let i=t===0?"treble":"bass";return t===0&&(n.Clefs.sort((s,o)=>s.Beat-o.Beat),n.Clefs.forEach(s=>{if(s.Beat<=e){i=s.Type;return}})),i}var R=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],bt=new Map([["treble",16],["bass",4]]);function Me(n){return Math.floor(440*Math.pow(2,(n-69)/12)*1e3)/1e3}function Ni(n,e,t=0){let i=0,s=69,o=0,a=t===0?16:34,f=a;if(e===s)return a;if(e>s)for(let r=s;r<e;r++)R[i]==="C"||R[i]==="F"?(f-=0,i===0?i=R.length-1:i-=1):(f-=1,i-=1);else if(s>e)for(let r=s;r>e;r--)R[i]==="B"||R[i]==="E"?(f+=0,i===R.length-1?i=0:i+=1):(f+=1,i+=1);return f}function Ne(n,e,t=0,i=0){let s=0,o=bt.get(n),a=69,f=a;if(e===o)return a+t;if(e>o)for(let r=o;r<e;r++)R[s]==="C"||R[s]==="F"?(f-=1,s-=1):(s===0?s=R.length-2:s-=2,f-=2);else for(let r=o;r>e;r--)R[s]==="B"||R[s]==="E"?(f+=1,s===R.length-1?s=0:s+=1):(f+=2,s+=2);return f+=t,f}function Re(){let n=new Map,e=new Map,t=0,i=0,s=45,o=0,a=11;for(let f=21;f<=127;f++)t>=R.length&&(t=0,i++),s=[0,2,3,5,7,8,10].includes(o)?s-1:s,n.set((R[t]+i).toString(),Me(f)),e.set(f,{NoteString:(R[t]+i).toString(),Frequency:Me(f),Line:s,Accidental:R[t].includes("#")?1:0}),t++,o>=a?o=0:o++;return e}function ve(n,e,t){let i=e.get(n),s={NoteString:i.NoteString,Line:i.Line,Frequency:i.Frequency,Accidental:i.Accidental};return t==="bass"&&(s.Line-=12),s}var C=class{constructor(e){this.Beat=e.Beat,this.Duration=e.Duration,this.Line=e.Line,this.Rest=e.Rest,this.Tied=e.Tied,this.Accidental=0,this.Staff=e.Staff,this.Clef=e.Clef,this.Selected=!1,this.SelType=1,this.Bounds=new p(0,0,0,0),this.Bounds.width=12,this.Bounds.height=10,this.Editable=e.Editable!==void 0?e.Editable:!0,this.ID=-1,this.Tuple=e.Tuple,e.TupleDetails&&(this.TupleDetails=e.TupleDetails)}SetBounds(e){this.Bounds=e}SetID(e){this.ID=e}SetTiedStartEnd(e,t){this.TiedStart=e,this.TiedEnd=t}IsHovered(e,t,i){return this.Bounds.IsHovered(e,t,i)}GetMidiNumber(){let e=this.Staff===0?this.Line:this.Line-1e3;return Ne(this.Clef,e,this.Staff)}};var ye=9;function Ie(n,e,t,i,s){Pe(n,e,i,{num:t,bounds:new p(0,0,0,0)},s)}function Ee(n,e,t,i,s,o){let a=!0,f=n.Divisions.find(u=>u.Bounds.IsHovered(t,i,s));if(!f){console.error("Beat Over Not Found");return}let r=n.GetLineHovered(i,f.Staff);n.Instrument.Staff===2&&(r.num=15),a&&Pe(n,e,f,r,o)}function Pe(n,e,t,i,s,o=1){let a=n.Notes.filter(m=>m.Beat===t.Beat);if(a.length<1){console.error("No notes found in division");return}let f=a[0].Tuple;f&&e!==t.Duration&&(e=e/a[0].TupleDetails.Count);let r=P(n,t.Beat,t.Staff),u={Beat:t.Beat,Duration:e,Line:i.num,Rest:s,Tied:!1,Staff:t.Staff,Tuple:f,TupleDetails:a[0].TupleDetails,Clef:r},l=new C(u);t.Duration===e?(n.ClearRestNotes(t.Beat,t.Staff),n.AddNote(l,!0)):Dt(u.Beat,u.Duration,n)&&pt(n,u,t.Staff),n.CreateDivisions(n.Camera,!0)}function w(n,e){J(n,e).DivGroups.forEach(i=>{let{Divisions:s,Notes:o}=i,a=O(o,s,e,n);s.forEach(f=>{let r=n.Notes.filter(u=>u.Beat===f.Beat&&u.Staff===e);r.sort((u,l)=>u.Line-l.Line),r.forEach((u,l)=>{let d=Se(r,l,a)?a===0?11:-11:0,h=ye,c=r.filter(S=>S.Accidental!==0).length;c>0&&(h+=ye*c-1),u.Rest||(u.Bounds.x=Math.floor(f.Bounds.x+h+d),u.Bounds.y=n.GetNotePositionOnLine(u.Line,u.Staff))})})})}function Dt(n,e,t,i=1){return n*e<=t.TimeSignature.top*(1/t.TimeSignature.bottom)}function Bt(n,e,t,i){let s=t.filter(a=>a.Beat===e&&a.Staff===i),o=s.find(a=>a.Rest);return o&&s.length>1?console.error("Rest found on beat with multiple notes, beat: ",e):o&&s.length===1&&n.ClearRestNotes(e,s[0].Staff),o!==void 0}function pt(n,e,t){let i=e.Duration,s=e.Beat;e.Rest&&(e.Line=E(n.Staves,t));let o=!1,a=-1,f=-1;n.Divisions.filter(r=>r.Staff===t).forEach((r,u)=>{if(o&&e.Rest&&(o=!1),i>=r.Duration&&s===r.Beat){n.ClearRestNotes(s,e.Staff),i>r.Duration&&o===!1&&!e.Rest&&(o=!0,a=r.Beat,f=r.Beat+(i-r.Duration)*n.TimeSignature.bottom);let l={Beat:r.Beat,Duration:r.Duration,Line:e.Line,Rest:e.Rest,Tied:o,Staff:r.Staff,Tuple:!1,Clef:P(n,r.Beat,r.Staff)},m=new C(l);o&&(m.SetTiedStartEnd(a,f),i-r.Duration<=0&&(o=!1)),i-=r.Duration,s+=r.Duration*n.TimeSignature.bottom,n.AddNote(m,!0)}else if(i<r.Duration&&s===r.Beat&&i>0){let l=n.Notes.filter(g=>g.Beat===r.Beat&&g.Staff===r.Staff);if(Bt(n,s,l,r.Staff)){let g={Beat:r.Beat,Duration:i,Line:e.Line,Rest:e.Rest,Tied:o,Staff:r.Staff,Tuple:!1,Clef:P(n,r.Beat,r.Staff)},b=new C(g);o&&(b.SetTiedStartEnd(a,f),i-r.Duration<=0&&(o=!1)),i=0,n.AddNote(b,!0),console.log("note added");return}let m={Beat:r.Beat,Duration:i,Line:e.Line,Rest:e.Rest,Tied:!1,Staff:r.Staff,Tuple:e.Tuple,TupleDetails:e.TupleDetails,Clef:P(n,r.Beat,r.Staff)},d=r.Duration-i,h=W(d).sort((g,b)=>g-b),c=r.Beat,S=r.Beat+d*n.TimeSignature.bottom;l.forEach(g=>{g.Duration=i,g.Tied=!0,g.SetTiedStartEnd(c,S);let b=r.Beat+i*n.TimeSignature.bottom;h.forEach((T,D)=>{let L=D<h.length-1,I={Beat:b,Duration:T,Line:g.Line,Rest:!1,Tied:!0,Staff:g.Staff,Tuple:g.Tuple,TupleDetails:g.TupleDetails,Clef:P(n,r.Beat,r.Staff)},B=new C(I);B.SetTiedStartEnd(c,S),n.AddNote(B,!0),b=b+T*n.TimeSignature.bottom})}),n.AddNote(new C(m),!0)}})}function xe(n,e){let t=0;for(let[i,s]of n)s.forEach(o=>{let a=o.Duration,f=o.Duration/e;t=f;let r=o.Beat;o.Duration=f,o.Tuple=!0;let u={StartBeat:o.Beat,EndBeat:o.Beat+a*i.TimeSignature.bottom,Value:a,Count:e};o.TupleDetails=u;for(let l=1;l<e;l++){let m=new C({Beat:r+f*i.TimeSignature.bottom,Duration:f,Line:o.Line,Rest:!0,Tied:!1,Staff:o.Staff,Tuple:!0,TupleDetails:u,Clef:P(i,r+f*i.TimeSignature.bottom,o.Staff)});r=m.Beat,i.AddNote(m,!0)}});return t}var Q=30;function Ae(n,e,t,i){let s=[],o=0,a=0;if(e.sort((f,r)=>f.Beat-r.Beat),e.filter(f=>f.Staff===t).length===0){let f={Beat:1,Duration:1,Line:E(n.Staves,t),Rest:!0,Tied:!1,Staff:t,Tuple:!1,Clef:t===0?"treble":"bass"};n.AddNote(new C(f))}return e.filter(f=>f.Staff===t).forEach(f=>{s.find(r=>r.Beat===f.Beat&&r.Staff===f.Staff)||(s.push({Beat:f.Beat,Duration:f.Duration,Bounds:ce(n,f.Beat,f.Duration,t,i),Staff:t}),f.Tuple?o=f.Beat+f.Duration/f.TupleDetails.Count*n.TimeSignature.bottom:o=f.Beat+f.Duration*n.TimeSignature.bottom,a+=f.Duration)}),a>0&&o-1<n.TimeSignature.bottom&&we(n,s,t),we(n,s,t),w(n,t),s}function ce(n,e,t,i,s){let o=n.Bounds.width*t,a=pe(n.Staves,i),f=n.Bounds.x+n.XOffset+(e-1)/n.TimeSignature.bottom*n.Bounds.width,r=n.Bounds.y+N(n.Staves,i);return new p(f,r,o,a)}function Ge(n,e,t){let i=e.filter(l=>l.Staff===t),s=e.filter(l=>l.Staff===0),o=e.filter(l=>l.Staff===1),a=o.length>s.length?o.length:s.length,f=Q*a,u=(n.Bounds.width-f)/a;i.sort((l,m)=>l.Beat-m.Beat),i.forEach((l,m)=>{if(l.Bounds.width=l.Duration*n.Bounds.width,m>0){let d=i[m-1].Bounds.x+i[m-1].Bounds.width;d!==l.Bounds.x&&(l.Bounds.x=d)}m===0&&i.length===1&&(l.Bounds.width=n.Bounds.width)})}function we(n,e,t){let i=e.sort((d,h)=>d.Beat-h.Beat),s=1,o=[];i.filter(d=>d.Staff===t).forEach((d,h)=>{let c=n.Notes.filter(S=>S.Beat===d.Beat);if(d.Beat===s)s=d.Beat+d.Duration*n.TimeSignature.bottom,c[0].Tuple&&(s=c[0].TupleDetails.EndBeat);else if(d.Beat>=s){let S=(d.Beat-s)/n.TimeSignature.bottom,g=W(S),b=s;g.sort(),g.forEach(T=>{o.push({Beat:b,Duration:T,Bounds:ce(n,b,T,d.Staff,n.Camera),Staff:d.Staff}),b+=T*n.TimeSignature.bottom}),s=d.Beat+d.Duration*n.TimeSignature.bottom}}),e.push(...o),o.forEach(d=>{n.Notes.find(g=>g.Beat===d.Beat)!==void 0&&console.error("Note found in division gap");let c=P(n,d.Beat,t),S={Beat:d.Beat,Duration:d.Duration,Line:E(n.Staves,t),Rest:!0,Tied:!1,Staff:d.Staff,Tuple:!1,Clef:c};n.AddNote(new C(S))});let a=n.TimeSignature.top/n.TimeSignature.bottom*n.TimeSignature.bottom+1,f=e.filter(d=>d.Staff===t);f=e.sort((d,h)=>d.Beat-h.Beat);let r=f[f.length-1],u=r.Beat+r.Duration*n.TimeSignature.bottom,l=[],m=a-u;if(m>0){let d=m/n.TimeSignature.bottom,h=W(d),c=u;h.sort(),h.forEach(S=>{l.push({Beat:c,Duration:S,Bounds:ce(n,c,S,r.Staff,n.Camera),Staff:t}),c+=S*n.TimeSignature.bottom})}e.push(...l),l.forEach(d=>{n.Notes.find(g=>g.Beat===d.Beat&&g.Staff===d.Staff)!==void 0&&console.error("Note found in division gap");let c=P(n,d.Beat,t),S={Beat:d.Beat,Duration:d.Duration,Line:E(n.Staves,t),Rest:!0,Tied:!1,Staff:d.Staff,Tuple:!1,Clef:c};n.AddNote(new C(S))})}function J(n,e){let t={DivGroups:[]},i=[],s=[],o=!1;return n.Divisions.filter(f=>f.Staff===e).sort((f,r)=>f.Beat-r.Beat).forEach((f,r)=>{let u=n.Notes.filter(m=>m.Beat===f.Beat&&m.Staff===e);u.sort((m,d)=>m.Line-d.Line);let l=ge(f.Beat,u,e);l&&o?(t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[],o=!1):l||(o?f.Duration>.125?(o=!1,t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[],i.push(f),s.push(u),t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[]):(f.Beat===3&&(t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[]),i.push(f),s.push(u),r===n.Divisions.filter(m=>m.Staff===e).length-1&&(t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[])):(i.push(f),s.push(u),f.Duration>.125?(t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[]):(o=!0,r===n.Divisions.filter(m=>m.Staff===e).length-1&&(t.DivGroups.push({Divisions:i,Notes:s}),i=[],s=[]))))}),t}function ge(n,e,t){let i=e.filter(o=>o.Beat===n&&o.Staff===t),s=i.find(o=>o.Rest);return s&&i.length>1&&console.error("Rest found on beat with multiple notes, beat: ",n),s!==void 0}function Fe(n,e,t){let i=[];e.sort((o,a)=>o.Bounds.x-a.Bounds.x);let s=new X(new p(e[0].Bounds.x,e[0].Bounds.y+e[0].Bounds.height,5,5),{x:e[0].Bounds.x,y:e[0].Bounds.y+e[0].Bounds.height},{x:e[e.length-1].Bounds.x,y:e[e.length-1].Bounds.y+e[e.length-1].Bounds.height});return i.push(s),i}var j=12;function ke(n){let e=[],t=n.filter(i=>i.Accidental!==0);switch(t.sort((i,s)=>i.Line-s.Line),t.length){case 0:return[];case 1:return[j];case 2:return[j,j*2];default:Math.abs(t[0].Line-t[t.length-1].Line)>4,e=Oe(t)}return e}function Oe(n){let e=[];return n.forEach((t,i)=>{i===0?e.push(j):e.push((n.length+1-i)*j)}),e}var be="m0 0 0-5.6448 2.4-.6624 0 5.616-2.4.6912zm4.7256-1.3656-1.65.4728 0-5.616 1.65-.4608 0-2.3328-1.65.4608 0-5.7382-.6756 0 0 5.9122-2.4.69 0-5.5798-.6372 0 0 5.7922-1.65.462 0 2.3376 1.65-.4608 0 5.6052-1.65.4596 0 2.328 1.65-.4608 0 5.7058.6372 0 0-5.9098 2.4-.66 0 5.551.6756 0 0-5.7598 1.65-.462 0-2.3364z",Tt="c-1.2495-.1955-2.5177-.1955-3.7791-.1938-.0272-.9231.1207-1.904-.2448-2.771-.2448-.5763-.7089-1.0302-1.1203-1.4977-.6579.5882-1.1985 1.3651-1.2512 2.2678-.051.6664-.0136 1.3345-.0255 2.0009-1.2614.0187-2.5347-.0425-3.7791.2057.2397-1.2376.1853-2.5024.2074-3.7553.9605-.0255 1.9873.1122 2.8798-.306.5253-.2465.9724-.6324 1.4178-.9996-.5814-.6579-1.3362-1.2376-2.2474-1.292-.6817-.0544-1.3668-.0153-2.0502-.0272-.0425-1.2444.102-2.5024-.1564-3.7315 1.2308.2227 2.4854.1649 3.7281.1819.0187.8857-.0799 1.8037.17 2.6554.1904.6511.7106 1.1526 1.1441 1.666.6137-.5338 1.1662-1.2036 1.2665-2.0417.0918-.7582.0187-1.5198.0612-2.2797 1.2529-.034 2.5432.1258 3.7553-.2703-.1802 1.2631-.1972 2.5466-.1836 3.8199-.8942.0255-1.8309-.0748-2.6809.2278-.646.2278-1.1543.7276-1.6677 1.1696.5576.5712 1.2291 1.0965 2.0587 1.1747.7616.0714 1.5266.0391 2.2899.0527.0187 1.2495-.0425 2.5109.2074 3.7434z",V="c0 .805-.3018 1.576-1.1298 2.6109-.8772 1.0963-1.6156 1.7237-2.5886 2.4615l0-4.8049c.2212-.5586.5474-1.0108.98-1.358.4312-.3458.868-.5194 1.3104-.5194.7308 0 1.1942.4144 1.3944 1.2404.0224.0672.0336.1904.0336.3696zm-.105-3.36c-.6034 0-1.2166.1666-1.841.5012-.6244.3332-1.2152.7798-1.7724 1.3356l0-10.1804-.7882 0 0 17.4367c0 .4928.1344.7392.4032.7392.1554 0 .3485-.1302.637-.3024.8166-.4873 1.3257-.8131 1.8788-1.1567.6308-.392 1.3412-.8497 2.2806-1.7457.6482-.651 1.1172-1.3076 1.4084-1.9684.2898-.6622.4354-1.3174.4354-1.9684 0-.9632-.2562-1.6478-.7686-2.0524-.5796-.4256-1.2054-.6384-1.8732-.6384z",Lt="m0 0-.7875.2813 0-6.4406-4.5281 1.9688 0-16.7063.7594-.3375 0 6.5531 4.5563-2.0813 0 16.7625zm-.7875-9 0-4.5-3.7688 1.6594 0 4.5 3.7688-1.6594z";function He(n,e,t,i,s){let{canvas:o,context:a,camera:f}=n,r="",u="";switch(t){case 0:r=`m ${e.Bounds.x+f.x-2} ${e.Bounds.y+f.y+16}`,r+=Lt;break;case 1:r=`m ${e.Bounds.x+f.x-6} ${e.Bounds.y+f.y+8}`,r+=be,v(n,"\uE262",e.Bounds.x-i,e.Bounds.y+3,s,e.Selected);break;case 2:r=`m ${e.Bounds.x+f.x-2} ${e.Bounds.y+f.y+10}`,r+=Tt;break;case-2:u=`m ${e.Bounds.x+f.x-15} ${e.Bounds.y+f.y+4}`,u+=V;case-1:r=`m ${e.Bounds.x+f.x-5} ${e.Bounds.y+f.y+4}`,r+=V,v(n,"\uE260",e.Bounds.x-i,e.Bounds.y+3,s,e.Selected);break;default:break}a.fillStyle="black"}var Ue=new Map([["CMaj/Amin",[]],["GMaj/Emin",["F#"]],["DMaj/Bmin",["F#","C#"]],["AMaj/F#min",["F#","C#","G#"]],["EMaj/C#min",["F#","C#","G#","D#"]],["BMaj/G#min",["F#","C#","G#","D#","A#"]],["F#Maj/D#min",["F#","C#","G#","D#","A#","E#"]],["C#Maj/A#min",["F#","C#","G#","D#","A#","E#","B#"]],["FMaj/Dmin",["Bb"]],["BbMaj/Gmin",["Bb","Eb"]],["EbMaj/Cmin",["Bb","Eb","Ab"]],["AbMaj/Fmin",["Bb","Eb","Ab","Db"]],["DbMaj/Bbmin",["Bb","Eb","Ab","Db","Gb"]],["GbMaj/Ebmin",["Bb","Eb","Ab","Db","Gb","Cb"]],["CbMaj/Abmin",["Bb","Eb","Ab","Db","Gb","Cb","Fb"]]]);function $e(n,e,t,i,s){let{canvas:o,context:a,camera:f}=n;a.fillStyle="black";let r=Ct(i,t),u="";r.Lines.forEach((l,m)=>{r.Accidental==="#"?(u=`m ${e.Bounds.x+s+m*5+f.x+5} 
          ${e.Bounds.y+l*5+f.y+4}`,u+=be):(u=`m ${e.Bounds.x+s+m*5+f.x-5} 
          ${e.Bounds.y+l*5+f.y+4}`,u+=V),a.fill(new Path2D(u))})}function Ct(n,e){let t={Accidental:"",Lines:[]},i=Ue.get(e),s="";switch(i.length>0&&(i[0].includes("#")?s="#":s="b"),t.Accidental=s,n){case"bass":break;case"treble":t.Lines=Mt(i,s);break;default:}return t}function Mt(n,e){let t=[];return e==="#"?t=[11,14,10,13,16,12,15].slice(0,n.length):t=[15,12,16,13,17,14,18].slice(0,n.length),t}function Nt(n,e,t,i){return n===0&&e===0||n===1&&e===2?t-=i:(n===1&&e===0||n===0&&e===2)&&(t+=i),t}function Rt(n,e,t,i){return n===0?t>22:e<8}function Ze(n,e,t,i,s){let o=[],a=9,f=O(n,e,t,i),r=Number.MAX_SAFE_INTEGER,u=Number.MIN_SAFE_INTEGER,l,m;n.forEach(g=>{g.forEach(b=>{b.Line<r&&(r=b.Line,l=b),b.Line>u&&(u=b.Line,m=b)})});let d=N(i.Staves,t)+E(i.Staves,t)*5,h=f===0?11.5:.25,c=q(i,{Divisions:e,Notes:n},f),S=e.length>1&&e[0].Duration<=.25;return e.forEach((g,b)=>{let T=b*(10/e.length-1),D=n[b],L=D.filter(M=>M.Accidental!==0).length;L>0&&(a+=a*L-1),D.sort((M,ft)=>M.Line-ft.Line);let I=f===0?D[0].Bounds.x+11:D[0].Bounds.x,B=new Z(new p(I,0,1.5,0));f===0?(B.Bounds.y=D[D.length-1].Bounds.y+2.5,B.Bounds.height=l.Bounds.y-D[D.length-1].Bounds.y-35):(B.Bounds.y=D[0].Bounds.y+2.5,B.Bounds.height=m.Bounds.y-D[0].Bounds.y+35);let U=i.Staves[t].TopLine<0?Math.abs(i.Staves[t].TopLine):i.Staves[t].TopLine,x=Te(i.Staves,t)+U;Rt(f,u,r,x)&&(B.Bounds.height=d-B.Bounds.y+i.Bounds.y),S&&(B.Bounds.height=Nt(f,c,B.Bounds.height,T)),o.push(B)}),o}var vt=10;var ze=9;function We(n,e,t,i,s,o,a,f,r,u){It(n,e,t,i,o,f,r,u.Theme),Et(n,e,i,s,u.Theme),n.Staves.forEach(l=>{wt(n,e,l.Num,u.Theme)})}function yt(n){if(n.Staves.length===0)return new p(0,0,0,0);let e=new p(n.Bounds.x,0,n.GetBoundsWithOffset().width,5),i=15-n.Staves[0].BotLine;return e.y=n.Bounds.y+n.GetMeasureHeight()+(i*5-2.5),e}function It(n,e,t,i,s,o,a,f){let{canvas:r,context:u,camera:l}=e;n.Divisions.forEach(d=>{if(d.Bounds.IsHovered(i.x,i.y,l)){let h=n.GetLineHovered(i.y,d.Staff);if(n.Instrument.Staff===2&&(h.num=15,h.bounds=yt(n)),s){let c=n.Bounds.y+h.num*(vt/2),S={Beat:d.Beat,Duration:a,Line:h.num,Rest:o,Tied:!1,Staff:d.Staff,Tuple:!1,TupleIndex:0,TupleCount:1,Clef:"treble"},g=new C(S);o?_(e.context,d,e.camera,g,n,f):(ue(g,e,new p(d.Bounds.x+ze,h.bounds.y,0,0),!0,!1,0,f),de([g],d,e,d.Staff,n,f))}}})}function Et(n,e,t,i,s){let{canvas:o,context:a,camera:f}=e;if(n.Selected&&(a.fillStyle=s.SelectColour,a.fillRect(n.Bounds.x+f.x,n.Bounds.y+f.y,n.Bounds.width+n.XOffset,n.Bounds.height)),a.fillStyle=s.NoteElements,Be(e,n,i,s),n.Staves.forEach(r=>{Le(e,n,r)}),n.RenderClef&&Pt(e,n,s),n.RenderKey)if("CMaj/Amin"!=="CMaj/Amin"){let u=n.RenderClef?24:4;$e(e,n,"CMaj/Amin","treble",u)}else n.RenderKey=!1;if(n.RenderTimeSig){let r=n.RenderClef?n.RenderKey?48:36:4;xt(e,n,"4","4",r,s)}}function Pt(n,e,t){let{canvas:i,context:s,camera:o}=n;e.Clefs.forEach(a=>{if(a.Beat===1)a.render(n,t);else{let f=e.Divisions.find(r=>r.Beat===a.Beat);a.Type==="treble"||a.Type}})}function xt(n,e,t,i,s,o){e.TimeSignature.render(n,e,o)}function wt(n,e,t,i){let{canvas:s,context:o,camera:a}=e;n.Divisions.filter(u=>u.Staff===t).forEach((u,l)=>{let m=n.Notes.filter(d=>d.Beat===u.Beat&&d.Staff===u.Staff);if(m.sort((d,h)=>d.Line-h.Line),ge(u.Beat,m,u.Staff)){_(o,u,a,m[0],n,i);return}de(n.Notes,u,e,t,n,i)}),J(n,t).DivGroups.forEach((u,l)=>{if(u.Divisions.length>0){let m=O(u.Notes,u.Divisions,t,n),d=q(n,u,m),h=Ze(u.Notes,u.Divisions,t,n,a),c=[];u.Divisions.length>1&&u.Divisions[0].Duration<.25&&(c=Fe(u,h,n),c.forEach(S=>S.Render(o,a,1,0,i))),h.forEach(S=>S.Render(o,a,i)),u.Divisions.forEach(S=>{let g=!1,b=n.Notes.filter(T=>T.Beat===S.Beat&&T.Staff===t);b.sort((T,D)=>T.Line-D.Line),b.forEach((T,D)=>{let L=Se(b,D,m);L&&(g=!0);let I=L?m===0?11:-11:0;if(T.Rest)_(o,S,a,T,n,i);else{ue(T,e,T.Bounds,T.Selected,L,m,i);let B=b.filter(x=>x.Accidental!==0);B.sort((x,M)=>x.Line-M.Line);let U=ke(B);B.forEach((x,M)=>{He(e,x,x.Accidental,U[M],i)})}}),b.forEach(T=>{let D=g&&m===0?11:0;Ce(e,T,S.Bounds.x+ze+D)})})}}),me(e,n.Divisions,n.Notes,0,n),le(e,n.Divisions,n.Notes,0,n,i),n.Instrument.Staff===1&&(me(e,n.Divisions,n.Notes,1,n),le(e,n.Divisions,n.Notes,1,n,i))}function Se(n,e,t){let i=!1,s=0,o=0,a=n[e].Line;if(n.length<=1)return i;for(let u=e+1;u<=n.length-1;u++){let l=n[u].Line;if(l-a===u-e||l-a===e-e)o++;else break}for(let u=e-1;u>=0;u--){let l=n[u].Line;if(a-l===e-u||a-l===e-e)s++;else break}let f=s+o+1,r=s+1;return f%2===0?i=t===0?r%2!==0:r%2===0:i=r%2===0,i}function Xe(n,e,t,i,s,o,a){var d;let r=n.Bounds.width,u=n.Bounds.height,l=n.Bounds.x,m=n.Bounds.y;if((d=o.PageSettings)!=null&&d.AutoSize&&(u=a[a.length-1].Bounds.y+a[a.length-1].GetMeasureHeight()+40,a.length<4&&(r=a[a.length-1].Bounds.x+a[a.length-1].GetBoundsWithOffset().width+40)),t.filter="blur(4px)",t.fillStyle=o.Theme.PageShadowColour,t.fillRect(l+i.x-4,m+i.y+4,r,u),t.filter="none",t.fillStyle=o.Theme.PageColour,t.fillRect(l+i.x,m+i.y,r,u),s){t.strokeStyle="rgba(51, 2, 16, 0.2)",t.beginPath(),t.setLineDash([10,10]),t.moveTo(l+n.Margins.left+i.x,m+i.y),t.lineTo(l+n.Margins.left+i.x,m+u+i.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(l+r-n.Margins.right+i.x,m+i.y),t.lineTo(l+r-n.Margins.right+i.x,m+u+i.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(l+i.x,m+n.Margins.top+i.y),t.lineTo(l+r+i.x,m+n.Margins.top+i.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(l+i.x,m+u-n.Margins.bottom+i.y),t.lineTo(l+r+i.x,m+u-n.Margins.bottom+i.y),t.stroke(),t.strokeStyle="black";let h="rgba(51, 2, 16, 0.8)",c="rgba(2,51,16,0.8)";H(l+n.Margins.right+i.x,m+i.y,"down",h,t),H(l+r-n.Margins.left+i.x,m+i.y,"down",h,t),H(l+i.x,m+n.Margins.top+i.y,"right",h,t),H(l+r+i.x,m+n.Margins.top+i.y,"left",h,t),H(l+i.x,m+u-n.Margins.bottom+i.y,"right",h,t),H(l+r+i.x,m+u-n.Margins.bottom+i.y,"left",h,t),n.PageLines.forEach(S=>{H(l+i.x-25,m+S.LineBounds.y+i.y+12.5,"right",c,t),t.strokeStyle=c,t.beginPath(),t.setLineDash([10,10]),t.moveTo(l+i.x,m+S.LineBounds.y+12.5+i.y),t.lineTo(l+r+i.x,m+S.LineBounds.y+12.5+i.y),t.stroke()}),t.strokeRect(n.MarginAdj[0].Bounds.x+i.x,n.MarginAdj[0].Bounds.y+i.y,n.MarginAdj[0].Bounds.width,n.MarginAdj[0].Bounds.height),t.stroke()}}function H(n,e,t,i,s){switch(s.fillStyle=i,s.beginPath(),t){case"down":s.moveTo(n,e-8),s.lineTo(n-9,e-8-9*1.7),s.lineTo(n+9,e-8-9*1.7);break;case"right":s.moveTo(n-8,e),s.lineTo(n-8-9*1.7,e-9),s.lineTo(n-8-9*1.7,e+9);break;case"left":s.moveTo(n+8,e),s.lineTo(n+8+9*1.7,e-9),s.lineTo(n+8+9*1.7,e+9);break;case"up":s.moveTo(n,e+8),s.lineTo(n-9,e+8+9*1.7),s.lineTo(n+9,e+8+9*1.7);break;default:}s.fill()}var je=(n,e,t,i,s,o,a,f,r,u,l,m)=>{var d,h;e.fillStyle=l.Theme.BackgroundColour,e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,n.width,n.height),(d=l.PageSettings)!=null&&d.RenderBackground&&e.fillRect(0,0,n.width,n.height),e.restore(),(h=l.PageSettings)!=null&&h.RenderPage&&i.forEach(c=>{Xe(c,n,e,a,u,l,t)}),e.fillStyle=l.Theme.NoteElements,t.forEach((c,S)=>{let g={canvas:n,context:e,camera:a},b=S===t.filter(T=>c.Instrument===T.Instrument).length-1;We(c,g,s.MeasureID,o,b,f,S,r,m,l)})},Ke=(n,e,t,i,s,o)=>{let a={canvas:n,context:e,camera:s}};var ee=(o=>(o[o.None=0]="None",o[o.Selection=1]="Selection",o[o.Deletion=2]="Deletion",o[o.InputChange=3]="InputChange",o[o.AddNote=4]="AddNote",o))(ee||{});function te(){return{messageString:"",messageData:{MessageType:0,Message:{msg:"",obj:{}}}}}var De=class{constructor(e,t,i=!1){this.Selected=!1,this.SelType=3,this.top=e,this.bottom=t,this.Editable=!0,this.TopPosition=[{x:0,y:0}],this.BotPosition=[{x:0,y:0}],this.Bounds=[new p(0,0,0,0)]}render(e,t,i){let s=Ye(this.top),o=Ye(this.bottom);t.Staves.forEach(a=>{v(e,s,this.TopPosition[a.Num].x,this.TopPosition[a.Num].y,i,this.Selected),v(e,o,this.BotPosition[a.Num].x,this.BotPosition[a.Num].y,i,this.Selected)})}SetBounds(e,t){this.Bounds=[],this.TopPosition=[],this.BotPosition=[],e.Staves.forEach(i=>{this.Bounds.push(new p(0,0,0,0)),this.TopPosition.push({x:0,y:0}),this.BotPosition.push({x:0,y:0});let s=e.Divisions.find(a=>a.Staff===i.Num).Bounds.y,o=E(e.Staves,i.Num);this.Bounds[i.Num].x=e.Bounds.x+e.XOffset-25,this.Bounds[i.Num].y=s+(o-4)*5,this.Bounds[i.Num].width=30,this.Bounds[i.Num].height=50,this.TopPosition[i.Num].x=this.Bounds[i.Num].x,this.TopPosition[i.Num].y=s+(o-2)*5,this.BotPosition[i.Num].x=this.Bounds[i.Num].x,this.BotPosition[i.Num].y=s+(o+2)*5})}IsHovered(e,t,i){return this.Bounds.filter(s=>s.IsHovered(e,t,i)).length>0}};function Ye(n){let e;switch(n){case 0:e="\uE080";break;case 1:e="\uE081";break;case 2:e="\uE082";break;case 3:e="\uE083";break;case 4:e="\uE084";break;case 5:e="\uE085";break;case 6:e="\uE086";break;case 7:e="\uE087";break;case 8:e="\uE088";break;case 9:e="\uE089";break}return e}function _e(n){return new De(n.top,n.bottom)}var K=class{constructor(e,t){this.Clefs=[];this.Staves=e.Staves,this.Message=e.Message,this.RunningID=t,this.ID=0,this.Selected=!1,this.Editable=!0,this.SelType=0,this.Instrument=e.Instrument,this.Line=0,this.Bounds=e.Bounds,this.Bounds.height=N(this.Staves),this.TimeSignature=_e(e.TimeSignature),this.KeySignature=e.KeySignature,this.Notes=e.Notes,this.Divisions=[],this.RenderClef=e.RenderClef,this.Instrument.Staff===2&&(this.RenderClef=!1),this.RenderKey=e.RenderKey,this.Camera=e.Camera,this.RenderTimeSig=e.RenderTimeSig,this.Page=e.Page,this.PageLine=e.Page.PageLines[0].Number,this.SetXOffset(),this.CreateDivisions(this.Camera),this.Staves.forEach((i,s)=>{let o=new F(0,e.Clefs[s].Type,1,i.Num);o.SetBounds(this,i.Num),this.Clefs.push(o)}),this.TimeSignature.SetBounds(this,0),this.TimeSignature.SetBounds(this,1)}GetLineHovered(e,t){let i=this.Camera,s=e-this.Bounds.y-i.y,o=Math.floor(s/5),a=o,f=new p(this.Bounds.x,0,this.Bounds.width+this.XOffset,5),r=this.Staves.find(d=>d.Num===t),u=N(this.Staves,t)/5;a=o+r.TopLine;let l=a-u,m=r.TopLine<0?a+Math.abs(r.TopLine):a-r.TopLine;return f.y=5*a,{num:l,bounds:f}}GetNotePositionOnLine(e,t){return N(this.Staves,t)+this.Bounds.y+(e-this.Staves[t].TopLine)*5-2.5}GetBoundsWithOffset(){return new p(this.Bounds.x,this.Bounds.y,this.Bounds.width+this.XOffset,this.Bounds.height)}SetXOffset(){this.XOffset=0,this.RenderClef&&(this.XOffset+=30),this.RenderKey&&(this.XOffset+=30),this.RenderTimeSig&&(this.XOffset+=30)}CreateDivisions(e,t=!1){this.Divisions=[],this.Staves.forEach(i=>{this.Divisions.push(...Ae(this,this.Notes,i.Num,e)),Ge(this,this.Divisions,i.Num),w(this,i.Num)})}Reposition(e){this.Bounds.x=e.Bounds.x+e.Bounds.width+e.XOffset,this.CreateDivisions(this.Camera)}GetMeasureHeight(){return N(this.Staves)}GetGrandMeasureHeight(){return 0}GetGrandMeasureMidLine(){return 0}NEW_GetMeasureHeight(){return N(this.Staves)}AddNote(e,t=!1){if(e.Rest?this.ClearNonRestNotes(e.Beat,e.Staff):this.ClearRestNotes(e.Beat,e.Staff),e.SetID(this.RunningID.count),this.RunningID.count++,this.Notes.push(e),t){let i={messageString:"AddNote",messageData:{Message:{msg:"AddingNote",obj:e},MessageType:4}};this.Message(i)}}ClearNonRestNotes(e,t){for(let i=this.Notes.length-1;i>=0;i--)this.Notes[i].Beat===e&&this.Notes[i].Rest===!1&&this.Notes[i].Staff===t&&this.Notes.splice(i,1)}ClearRestNotes(e,t){for(let i=this.Notes.length-1;i>=0;i--)this.Notes[i].Beat===e&&this.Notes[i].Rest===!0&&this.Notes[i].Staff===t&&this.Notes.splice(i,1)}ClearMeasure(e){for(let t=this.Notes.length-1;t>=0;t--)this.Notes[t].Editable&&!e.includes(this.Notes[t])&&this.Notes.splice(t,1)}DeleteSelected(){for(let e=this.Notes.length-1;e>=0;e--)if(this.Notes[e].Selected&&this.Notes[e].Editable){let t=this.Notes[e].Beat,i=this.Notes[e].Duration,s=this.Notes[e].Staff,o=this.Notes[e].Tuple,a=this.Notes[e].TupleDetails;if(this.Notes.splice(e,1),this.Notes.filter(r=>r.Beat===t).length===0){let r=P(this,t,s),u={Beat:t,Duration:i,Line:15,Rest:!0,Tied:!1,Staff:s,Tuple:o,TupleDetails:a,Clef:r};this.AddNote(new C(u))}}}GetMinimumWidth(){if(this.Notes.filter(o=>o.Rest!==!0).length===0)return Q*4;let e=this.Divisions.filter(o=>o.Staff===0),t=this.Divisions.filter(o=>o.Staff===1),i=this.Divisions.sort((o,a)=>o.Duration-a.Duration)[0].Duration;return(e.length>t.length?e.length:t.length)*Q}ReturnSelectableElements(){let e=[];return e.push(...this.Notes),e.push(...this.Clefs),e}IsHovered(e,t,i){return this.GetBoundsWithOffset().IsHovered(e,t,i)}ChangeTimeSignature(e,t,i){this.TimeSignature.top=e,this.TimeSignature.bottom=t}};var At=5,Gt=24,Ft=5,qe=(Gt-At)*Ft;function Je(n,e){let t=0;if(e.DefaultStaffType)switch(e.DefaultStaffType){case"rhythm":t=2;break;case"grand":t=1;break;case"single":default:t=0}return{Position:{x:0,y:n},Staff:t,Staves:[new A(0)]}}var Qe=(n,e,t,i,s,o)=>{let a=e.Staff===0?qe*2:qe,f={Instrument:e,Bounds:new p(e.Position.x,t.PageLines[0].LineBounds.y,150,a),TimeSignature:{top:4,bottom:4},KeySignature:"CMaj/Amin",Notes:[],Clefs:[new F(0,"treble",1,0)],Staves:[new A(0)],RenderClef:!0,RenderTimeSig:!0,RenderKey:!1,Camera:i,Page:t,Message:s,Settings:o};return new K(f,n)},ie=(n,e,t,i,s,o,a,f,r,u=!1,l,m)=>{let d={Instrument:n,Bounds:e,TimeSignature:t,KeySignature:i,Notes:[],Clefs:s,Staves:o,RenderClef:!1,RenderTimeSig:!1,RenderKey:!1,Camera:a,Page:r,Message:l,Settings:m};return new K(d,f)};var ne=class{constructor(e,t){this.x=e,this.y=t,this.oldX=e,this.oldY=t,this.Zoom=1}};var oe=class{constructor(){this.Measures=[],this.Clefs=[],this.Notes=new Map,this.Elements=new Map}TrySelectElement(e,t,i,s,o,a,f){let r,u=[],l=this.Elements.get(e)?this.Elements.get(e):[];return w(e,0),u.push(...e.Notes),u.push(...e.Clefs),u.push(e.TimeSignature),u.forEach(m=>{if(m.IsHovered(t,i,s)&&m.Selected===!1){if(m.Selected=!0,l.push(m),m.SelType===1){let d=m,h={messageData:{MessageType:1,Message:{msg:"selected",obj:d}},messageString:"Selected Note"};if(a(h),d.Tied){let c=se(d,e);l.push(...c)}}r=m,this.Elements.set(e,l)}}),r}DeselectAllElements(e){for(let[t,i]of e)i.forEach(s=>{s.Selected=!1}),e.delete(t);return new Map}SelectElement(){return void 0}DeselectAll(){for(let[e,t]of this.Notes)t.forEach(i=>{i.Selected=!1}),this.Notes.delete(e);for(let[e,t]of this.Elements)t.forEach(i=>{i.Selected=!1}),this.Elements.delete(e)}DeselectNote(e){let t=-1;for(let[i,s]of this.Notes)s.forEach((o,a)=>{o===o&&(t=a)}),t>=0&&this.RemoveDeselected([t],i)}RemoveDeselected(e,t){e.sort();for(let i=e.length-1;i>=0;i--)this.Notes.get(t).splice(i,1);this.Notes.get(t).length===0&&this.Notes.delete(t)}SelectById(e,t){let i;return this.DeselectAll(),e.forEach(s=>{s.Notes.forEach(o=>{if(o.ID===t){o.Selected=!0,i=o;let a=[];a.push(o),o.Tied&&a.push(...se(o,s)),this.Elements.set(s,a)}})}),i}SelectMeasure(e){if(this.Measures.find(t=>t.ID===e.ID)){let t=this.Measures.indexOf(e);e.Selected=!1,this.Measures.splice(t,1)}else this.Measures.push(e),e.Selected=!0}SelectClef(e){if(this.Clefs.find(t=>t.ID===e.ID)){let t=this.Clefs.indexOf(e);e.Selected=!1,this.Clefs.splice(t,1)}else this.Clefs.map(t=>t.Selected=!1),this.Clefs=[],this.Clefs.push(e),e.Selected=!0}SelectNote(e,t,i,s,o){let a=!1;return e.Divisions.forEach(f=>{e.Notes.filter(u=>u.Beat===f.Beat).forEach(u=>{if(u.Bounds.IsHovered(t,i,s)){if(u.Selected=!0,this.Notes.has(e)){let m=this.Notes.get(e);m.find(d=>d===u)||(m.push(u),u.Tied&&m.push(...se(u,e)),this.Notes.set(e,m))}else{let m=[];m.push(u),u.Tied&&m.push(...se(u,e)),this.Notes.set(e,m)}a=!0}else if(u.Selected&&!o){let m=!0;u.Tied&&(m=e.Notes.filter(h=>h!==u&&h.Beat>=u.TiedStart&&h.Beat<=u.TiedEnd&&h.Line===u.Line&&h.Staff===u.Staff&&h.Selected===!0).length===0),m&&(this.DeselectNote(u),u.Selected=!1)}})}),!a&&!o?(this.DeselectAll(),!1):!0}};function se(n,e){let t=[],i=n.TiedStart,s=n.TiedEnd;return e.Notes.filter(a=>a!==n&&a.Beat>=i&&a.Beat<=s&&a.Staff===n.Staff&&a.Line===n.Line).forEach(a=>{a.Selected=!0,t.push(a)}),t}var Ot='{"Measures":[{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":2,"Beat":1,"Duration":0.5,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":5,"Beat":1,"Duration":0.5,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":66,"Beat":1,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":70,"Beat":1.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":71,"Beat":2,"Duration":0.125,"Line":1037,"Rest":false,"Tied":false,"Staff":1},{"ID":73,"Beat":2.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":6,"Beat":3,"Duration":0.25,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":8,"Beat":3,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":9,"Beat":3,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":74,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":77,"Beat":3.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":10,"Beat":4,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":78,"Beat":4,"Duration":0.125,"Line":1038,"Rest":false,"Tied":false,"Staff":1},{"ID":80,"Beat":4.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":100,"y":87.5,"width":263.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":17,"Beat":1,"Duration":0.25,"Line":19,"Rest":false,"Tied":false,"Staff":0},{"ID":20,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":21,"Beat":1,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":81,"Beat":1,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":84,"Beat":1.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":22,"Beat":2,"Duration":0.25,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":85,"Beat":2,"Duration":0.125,"Line":1039,"Rest":false,"Tied":false,"Staff":1},{"ID":87,"Beat":2.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":23,"Beat":3,"Duration":0.25,"Line":10,"Rest":false,"Tied":false,"Staff":0},{"ID":25,"Beat":3,"Duration":0.25,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":26,"Beat":3,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":88,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":91,"Beat":3.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":27,"Beat":4,"Duration":0.25,"Line":9,"Rest":false,"Tied":false,"Staff":0},{"ID":92,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":94,"Beat":4.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":423.3333333333333,"y":87.5,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":30,"Beat":1,"Duration":0.25,"Line":11,"Rest":false,"Tied":false,"Staff":0},{"ID":33,"Beat":1,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":34,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":95,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":99,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":35,"Beat":2,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":100,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":102,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":36,"Beat":3,"Duration":0.5,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":37,"Beat":3,"Duration":0.5,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":38,"Beat":3,"Duration":0.5,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":103,"Beat":3,"Duration":0.125,"Line":1051,"Rest":false,"Tied":false,"Staff":1},{"ID":106,"Beat":3.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":107,"Beat":4,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":109,"Beat":4.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":686.6666666666666,"y":87.5,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":41,"Beat":1,"Duration":0.25,"Line":21,"Rest":false,"Tied":false,"Staff":0},{"ID":44,"Beat":1,"Duration":0.25,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":45,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":110,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":114,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":46,"Beat":2,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":115,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":117,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":52,"Beat":3,"Duration":0.25,"Line":20,"Rest":false,"Tied":false,"Staff":0},{"ID":53,"Beat":3,"Duration":0.25,"Line":19,"Rest":false,"Tied":false,"Staff":0},{"ID":118,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":121,"Beat":3.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":55,"Beat":4,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":122,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":57,"Beat":4.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":124,"Beat":4.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":100,"y":375,"width":263.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":125,"Beat":1,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":173,"Beat":1,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":129,"Beat":1.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":177,"Beat":1.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":130,"Beat":2,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":178,"Beat":2,"Duration":0.125,"Line":1037,"Rest":false,"Tied":false,"Staff":1},{"ID":180,"Beat":2.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":131,"Beat":3,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":181,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":184,"Beat":3.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":133,"Beat":4,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":185,"Beat":4,"Duration":0.125,"Line":1038,"Rest":false,"Tied":false,"Staff":1},{"ID":187,"Beat":4.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":423.3333333333333,"y":375,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":134,"Beat":1,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":188,"Beat":1,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":192,"Beat":1.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":137,"Beat":2,"Duration":0.25,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":193,"Beat":2,"Duration":0.125,"Line":1039,"Rest":false,"Tied":false,"Staff":1},{"ID":195,"Beat":2.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":138,"Beat":3,"Duration":0.125,"Line":10,"Rest":false,"Tied":false,"Staff":0},{"ID":196,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":141,"Beat":3.5,"Duration":0.125,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":199,"Beat":3.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":142,"Beat":4,"Duration":0.125,"Line":10,"Rest":false,"Tied":false,"Staff":0},{"ID":200,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":144,"Beat":4.5,"Duration":0.125,"Line":9,"Rest":false,"Tied":false,"Staff":0},{"ID":202,"Beat":4.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":686.6666666666666,"y":375,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":145,"Beat":1,"Duration":0.125,"Line":11,"Rest":false,"Tied":false,"Staff":0},{"ID":203,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":149,"Beat":1.5,"Duration":0.125,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":207,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":150,"Beat":2,"Duration":0.125,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":208,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":152,"Beat":2.5,"Duration":0.125,"Line":11,"Rest":false,"Tied":false,"Staff":0},{"ID":210,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":153,"Beat":3,"Duration":0.125,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":211,"Beat":3,"Duration":0.125,"Line":1051,"Rest":false,"Tied":false,"Staff":1},{"ID":156,"Beat":3.5,"Duration":0.125,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":214,"Beat":3.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":157,"Beat":4,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":215,"Beat":4,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":159,"Beat":4.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":217,"Beat":4.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":100,"y":662.5,"width":395,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":160,"Beat":1,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":218,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":164,"Beat":1.5,"Duration":0.125,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":222,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":165,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":223,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":167,"Beat":2.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":225,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":168,"Beat":3,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":226,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":229,"Beat":3.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":170,"Beat":4,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":230,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":172,"Beat":4.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":232,"Beat":4.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":555,"y":662.5,"width":395,"height":190},"ShowClef":false,"ShowTime":false}]}',kt='{"Measures":[{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":2,"Beat":1,"Duration":0.03125,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":54,"Beat":1,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":8,"Beat":1.125,"Duration":0.03125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":9,"Beat":1.5,"Duration":0.03125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":12,"Beat":1.625,"Duration":0.03125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":13,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":58,"Beat":2,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":15,"Beat":2.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":16,"Beat":3,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":60,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":19,"Beat":3.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":100,"y":87.5,"width":383.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":22,"Beat":1,"Duration":0.0625,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":63,"Beat":1,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":27,"Beat":1.25,"Duration":0.0625,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":28,"Beat":1.5,"Duration":0.0625,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":30,"Beat":1.75,"Duration":0.0625,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":67,"Beat":2,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":69,"Beat":2.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":543.3333333333333,"y":87.5,"width":233.33333333333334,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":33,"Beat":1,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":70,"Beat":1,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":74,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":36,"Beat":2,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":37,"Beat":3,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":776.6666666666666,"y":87.5,"width":173.33333333333334,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":41,"Beat":1,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":75,"Beat":1,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":44,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":89,"Beat":2,"Duration":0.25,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":46,"Beat":2.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":47,"Beat":3,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":91,"Beat":3,"Duration":0.25,"Line":1043,"Rest":false,"Tied":false,"Staff":1},{"ID":50,"Beat":3.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":51,"Beat":4,"Duration":0.125,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":92,"Beat":4,"Duration":0.25,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":53,"Beat":4.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":100,"y":375,"width":485,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":85,"Beat":1,"Duration":1,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":86,"Beat":1,"Duration":1,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":645,"y":375,"width":305,"height":190},"ShowClef":false,"ShowTime":false}]}';var ae=[{name:"Canon in C",file:Ot},{name:"Random FIle One",file:kt}];function Ve(n,e,t){switch(e){case t.addmeasure:n.AddMeasure();break;case t.changeinputmode:n.ChangeInputMode();break;case t.value1:n.SetNoteValue(.03125);break;case t.value2:n.SetNoteValue(.0625);break;case t.value3:n.SetNoteValue(.125);break;case t.value4:n.SetNoteValue(.25);break;case t.value5:n.SetNoteValue(.5);break;case t.value6:n.SetNoteValue(1);break;case t.restInput:n.RestInput=!n.RestInput;break;case t.delete:n.Delete();break;case t.sharpen:n.Sharpen();break;case t.flatten:n.Flatten();break;case t.scaleToggle:break;case t.save:n.Save();break;case t.load:n.LoadSheet(ae[0].file);case t.test_triplet:n.CreateTriplet();default:}}var Ht={left:40,right:40,top:40,bottom:40},et=6,Ut=210*et,$t=297*et,re=class{constructor(e,t,i){this.Margins=Ht,this.MarginAdj=[],this.Number=i,this.Bounds=new p(e,t,Ut,$t),this.MarginAdj.push({Name:"left",Direction:"horizontal",Bounds:new p(this.Bounds.x+this.Margins.left-12.5,this.Bounds.y-25,25,25)}),this.PageLines=[],this.PageLines.push({Number:1,YPos:t+this.Margins.top,LineBounds:new p(this.Bounds.x-50,t+this.Margins.top-12.5,25,25)})}AddLine(e){let t=this.PageLines[this.PageLines.length-1],i={Number:t.Number+1,YPos:this.Bounds.y+this.Margins.top,LineBounds:new p(this.Bounds.x-50,t.LineBounds.y+e-12.5,25,25)};return this.PageLines.push(i),i}};function it(n,e,t,i=150){let s=e;if(!s){console.error("No page found!");return}let o=0,a=0,f=1,r=0,u=s.Bounds.width-(s.Margins.left+s.Margins.right);if(t===!1&&t!==null){n.forEach(l=>{l.PageLine=f});return}n.forEach((l,m)=>{r++;let d=l.GetMinimumWidth()+l.XOffset;(o+d>u||r>4)&&(f++,r=1,e.PageLines.length<f&&e.AddLine(i),o=0),o+=d,l.Page=e[a],l.PageLine=f})}function tt(n,e,t){var s,o;let i=0;return(o=(s=e.FormatSettings)==null?void 0:s.MeasureFormatSettings)!=null&&o.MaxWidth?i=e.FormatSettings.MeasureFormatSettings.MaxWidth:i=350,i}function nt(n,e,t,i){let s=e.Bounds.width-(e.Margins.left+e.Margins.right);e.PageLines.forEach(o=>{let a=n.filter(u=>u.PageLine===o.Number),f=0;a.forEach((u,l)=>{f+=u.GetMinimumWidth()+u.XOffset});let r=s-f;a.forEach((u,l)=>{if(u.Bounds.y=o.LineBounds.y,l===0){u.Bounds.x=e.Bounds.x+e.Margins.left,u.RenderClef=u.Instrument.Staff!==2,u.RenderTimeSig=!0,u.RenderKey=!1,u.SetXOffset();let m=tt(e,i,t),d=u.GetMinimumWidth()+r/a.length,h=m&&d>m?m:d;u.Bounds.width=h,u.CreateDivisions(t)}else{u.RenderClef=!1,u.RenderTimeSig=!1,u.RenderKey=!1,u.SetXOffset();let m=tt(e,i,t),d=u.GetMinimumWidth()+r/a.length,h=m&&d>m?m:d;u.Bounds.width=h,a[l].Reposition(a[l-1]),u.CreateDivisions(t)}u.Clefs.forEach(m=>{m.SetBounds(u,m.Staff)}),u.TimeSignature.SetBounds(u,0),u.Instrument.Staff===1&&u.TimeSignature.SetBounds(u,1)})})}var st=(n,e,t,i,s,o)=>{let a={count:0};JSON.parse(s).Measures.forEach((r,u)=>{i.Staff===2&&(r.ShowClef=!1);let l=[];r.Notes.forEach((d,h)=>{let c={Beat:d.Beat,Duration:d.Duration,Line:d.Line,Rest:d.Rest,Tied:d.Tied,Staff:d.Staff,Tuple:!1,Clef:d.Clef,Editable:!1},S=new C(c);l.push(S)});let m=ie(i,r.Bounds,r.TimeSignature,"CMaj/Amin",r.Clefs,r.Staves,t,a,e,r.ShowClef,o);m.Notes=l,n.Measures.push(m),m.CreateDivisions(t)})},ot=n=>{let e={Measures:[]};return n.Measures.forEach((t,i)=>{let s=[];t.Notes.forEach((o,a)=>{o.Rest||s.push({ID:o.ID,Beat:o.Beat,Duration:o.Duration,Line:o.Line,Rest:o.Rest,Tied:o.Tied,Staff:o.Staff,Clef:o.Clef,Editable:!1})}),e.Measures.push({Clefs:t.Clefs,Staves:t.Staves,TimeSignature:t.TimeSignature,Notes:s,Bounds:t.Bounds,ShowClef:t.RenderClef,ShowTime:t.RenderTimeSig})}),console.log(JSON.stringify(e)),JSON.stringify(e)};var fe=class{constructor(e,t,i,s,o,a=!1){var u,l,m;this.Config=o,this.PitchMap=Re(),this.Message=te(),this.NotifyCallback=s,this.Debug=!0,this.Canvas=e,this.Container=t,this.Selector=new oe,this.Context=i,this.Load=a,this.HoveredElements={MeasureID:-1},this.Zoom=1,this.RunningID={count:0},this.CamDragging=!1,this.DraggingPositions={x1:0,y1:0,x2:0,y2:0};let f=0,r=20;if((u=this.Config.CameraSettings)!=null&&u.StartingPosition&&(f=this.Config.CameraSettings.StartingPosition.x,r=this.Config.CameraSettings.StartingPosition.y),this.Camera=new ne(f,r),this.Camera.Zoom=1,this.NoteValue=.5,this.StartDragY=0,this.EndDragY=0,this.DragLining=!1,!this.Load){let d=new re(0,0,1);(l=this.Config.PageSettings)!=null&&l.PageWidth&&(d.Bounds.width=this.Config.PageSettings.PageWidth);let h={Instruments:[],KeySignature:[{key:"CMaj",measureNo:0}],Measures:[],Pages:[d]},c=h.Pages[0];h.Instruments.push(Je(20,this.Config)),h.Measures.push(Qe(this.RunningID,h.Instruments[0],c,this.Camera,this.NotifyCallback,this.Config.MeasureSettings)),this.Sheet=new Y(h)}this.NoteInput=!1,this.RestInput=!1,this.Formatting=!1,(m=this.Config.CameraSettings)!=null&&m.Zoom&&(this.Camera.Zoom=this.Config.CameraSettings.Zoom,this.SetCameraZoom(this.Camera.Zoom),this.ResizeMeasures(this.Sheet.Measures)),this.Update(0,0)}Hover(e,t){if(e=e/this.Camera.Zoom,t=t/this.Camera.Zoom,this.CamDragging){this.Camera.x=Math.floor(this.Camera.oldX+e-this.DraggingPositions.x1),this.Camera.y=Math.floor(this.Camera.oldY+t-this.DraggingPositions.y1),this.Update(e,t);return}this.DraggingNote&&(this.DragNote(e,t),this.Update(e,t)),this.Formatting&&this.DragLining&&(this.DragLiner(e,t),this.Update(e,t)),this.HoveredElements.MeasureID=-1,this.NoteInput&&this.Sheet.Measures.forEach(i=>{i.GetBoundsWithOffset().IsHovered(e,t,this.Camera)&&i.Divisions.forEach(s=>{s.Bounds.IsHovered(e,t,this.Camera)&&(w(i,0),w(i,1))})}),this.Update(e,t)}Delete(){for(let[e,t]of this.Selector.Elements)e.DeleteSelected(),e.CreateDivisions(this.Camera)}Input(e,t,i){e=e/this.Camera.Zoom,t=t/this.Camera.Zoom,!this.NoteInput&&this.Formatting&&this.SelectLiner(e,t),this.HoveredElements.MeasureID=-1;let s=this.Sheet.Measures.find(o=>o.GetBoundsWithOffset().IsHovered(e,t,this.Camera));if(s===void 0){i||(this.Selector.DeselectAll(),this.Message=te(),this.Message.messageString="msr undefined",this.NotifyCallback(this.Message),this.Update(e,t));return}if(this.NoteInput)this.NoteInput&&(Ee(s,this.NoteValue,e,t,this.Camera,this.RestInput),this.ResizeMeasures(this.Sheet.Measures.filter(o=>o.Instrument===s.Instrument)));else{let o=!1;i||(this.Selector.Elements=this.Selector.DeselectAllElements(this.Selector.Elements)),(this.Selector.TrySelectElement(s,e,t,this.Camera,i,this.NotifyCallback,this.Selector.Elements)===void 0&&this.Config.FormatSettings.MeasureFormatSettings.Selectable===!0||this.Config.FormatSettings.MeasureFormatSettings.Selectable===void 0)&&this.Selector.SelectMeasure(s),this.DraggingNote||(this.DraggingNote=!0);let f=s.Divisions.find(r=>r.Bounds.IsHovered(e,t,this.Camera));f&&(this.StartLine=s.GetLineHovered(t,f.Staff).num)}this.Update(e,t)}Update(e,t){this.Render({x:e,y:t})}Render(e){je(this.Canvas,this.Context,this.Sheet.Measures,this.Sheet.Pages,this.HoveredElements,e,this.Camera,this.NoteInput,this.RestInput,this.Formatting,this.Config,this.NoteValue),this.Debug&&Ke(this.Canvas,this.Context,this.Sheet,e,this.Camera,this.Selector)}AddMeasure(){let e=this.Sheet.Measures.length,t=this.Sheet.Measures[this.Sheet.Measures.length-1],i=0;this.Sheet.Instruments.forEach(s=>{let o=this.Sheet.Pages[0].PageLines[this.Sheet.Pages[0].PageLines.length-1],a=new p(i,o.LineBounds.y,150,t.Bounds.height),f=ie(s,a,t.TimeSignature,t.KeySignature,t.Clefs,t.Staves,this.Camera,this.RunningID,this.Sheet.Pages[0],!1,this.NotifyCallback,this.Config.MeasureSettings);this.Sheet.Measures.push(f),this.ResizeMeasures(this.Sheet.Measures.filter(r=>r.Instrument===s))})}ChangeInputMode(){this.NoteInput=!this.NoteInput}SelectLiner(e,t){let i;return this.DragLining||(this.LineNumber=-1),this.Sheet.Pages.forEach(s=>{s.PageLines.forEach(o=>{o.LineBounds.IsHovered(e,t,this.Camera)&&(i=o.LineBounds,this.DragLining||(this.StartDragY=t,this.DragLining=!0,this.LinerBounds=i,this.LineNumber=o.Number))})}),i}DragLiner(e,t){if(this.LinerBounds){this.LinerBounds.y=this.LinerBounds.y+(t-this.StartDragY);let i=this.Sheet.Pages[0];this.LinerBounds.y+12.5<=i.Bounds.y+i.Margins.top&&(this.LinerBounds.y=i.Bounds.y+i.Margins.top-12.5),this.StartDragY=t,this.Sheet.Measures.forEach(s=>{s.PageLine===this.LineNumber&&(s.Bounds.y=this.LinerBounds.y)}),this.ResizeMeasures(this.Sheet.Measures)}}DragNote(e,t){let i=this.Sheet.Measures.find(a=>a.GetBoundsWithOffset().IsHovered(e,t,this.Camera));if(i===void 0){this.DraggingNote=!1,this.StartLine=-1,this.EndLine=-1;return}let s=i.Divisions.find(a=>a.Bounds.IsHovered(e,t,this.Camera));s&&(this.EndLine=i.GetLineHovered(t,s.Staff).num);let o=this.EndLine-this.StartLine;for(let[a,f]of this.Selector.Elements)f.filter(r=>r.SelType===1).forEach(r=>{if(r.Selected&&r.Editable&&(r.Line+=o,w(a,r.Staff),o!==0)){let u={messageData:{MessageType:1,Message:{msg:"selected",obj:r}},messageString:"Selected Note"};this.Message=u,this.NotifyCallback(this.Message)}});this.StartLine=this.EndLine}StopNoteDrag(e,t){this.DraggingNote&&(this.StartLine=-1,this.EndLine=-1,this.DraggingNote=!1),this.DragLining&&(this.DragLining=!1)}SetCameraDragging(e,t,i){var s;if(((s=this.Config.CameraSettings)==null?void 0:s.DragEnabled)===!1){this.CamDragging=!1;return}this.CamDragging=e,this.CamDragging?(this.DraggingPositions.x1=t/this.Camera.Zoom,this.DraggingPositions.y1=i/this.Camera.Zoom):(this.DraggingPositions.x1=0,this.DraggingPositions.y1=0,this.DraggingPositions.x2=0,this.DraggingPositions.y2=0,this.Camera.oldX=this.Camera.x,this.Camera.oldY=this.Camera.y)}AlterZoom(e){this.Zoom+=e,this.Camera.Zoom=this.Zoom,this.Context.setTransform(this.Camera.Zoom,0,0,this.Camera.Zoom,0,0),this.Update(0,0)}SetCameraZoom(e){this.Zoom=e,this.Camera.Zoom=this.Zoom,this.Context.setTransform(this.Camera.Zoom,0,0,this.Camera.Zoom,0,0),this.Update(0,0)}ResizeFirstMeasure(){this.Sheet.Measures[0].CreateDivisions(this.Camera);for(let e=1;e<this.Sheet.Measures.length;e++)this.Sheet.Measures[e].Reposition(this.Sheet.Measures[e-1]);this.Update(0,0)}ResizeMeasures(e){var o,a,f;let s=(e[0].Instrument.Staff===2,200);it(e,this.Sheet.Pages[0],(o=this.Config.PageSettings)==null?void 0:o.UsePages,s),nt(e,this.Sheet.Pages[0],this.Camera,this.Config),(a=this.Config.CameraSettings)!=null&&a.CenterMeasures?this.CenterMeasures():(f=this.Config.CameraSettings)!=null&&f.CenterPage&&this.CenterPage(),this.Update(0,0)}SetNoteValue(e){this.NoteValue=e}SetAccidental(e){for(let[t,i]of this.Selector.Elements)i.forEach(s=>{if(s.SelType===1){let o=s;o.Accidental=e,this.Message=te();let a={messageData:{MessageType:1,Message:{msg:"selected",obj:o}},messageString:"Selected Note"};this.Message=a,this.NotifyCallback(a)}});this.Update(0,0)}Sharpen(){for(let[e,t]of this.Selector.Elements)t.forEach(i=>{if(i.SelType===1){let s=i;s.Accidental+=1,s.Accidental>2&&(s.Accidental=2)}});this.Update(0,0)}Flatten(){for(let[e,t]of this.Selector.Elements)t.forEach(i=>{if(i.SelType===1){let s=i;s.Accidental-=1,s.Accidental<-2&&(s.Accidental=-2)}});this.Update(0,0)}ScaleToggle(){return this.Camera.Zoom!==1?(this.Camera.Zoom=1,this.Zoom=1):this.Camera.Zoom=1,this.Camera.Zoom}KeyInput(e,t){Ve(this,e,t)}SelectById(e){let t=this.Selector.SelectById(this.Sheet.Measures,e);return this.Update(0,0),t}ToggleFormatting(){this.Formatting=!this.Formatting,this.Formatting&&(this.NoteInput=!1,this.RestInput=!1)}Save(){ot(this.Sheet)}LoadSheet(e){this.Sheet.Measures=[],st(this.Sheet,this.Sheet.Pages[0],this.Camera,this.Sheet.Instruments[0],e,this.NotifyCallback),this.ResizeMeasures(this.Sheet.Measures),this.Update(0,0)}GetSaveFiles(){return ae}CreateTriplet(){this.NoteValue=xe(this.Selector.Notes,3),this.ResizeMeasures(this.Sheet.Measures),this.Update(0,0)}ChangeTimeSignature(e,t,i=!1){for(let[s,o]of this.Selector.Elements)s.ChangeTimeSignature(e,t,i)}CenterMeasures(){var i,s,o;let e=100;(s=(i=this.Config.FormatSettings)==null?void 0:i.MeasureFormatSettings)!=null&&s.MaxWidth&&(e=this.Config.FormatSettings.MeasureFormatSettings.MaxWidth);let t=(this.Canvas.clientWidth-(e+e/2)*this.Camera.Zoom)/4;if(this.Camera.x=t,this.Canvas.clientWidth<e*this.Camera.Zoom)this.SetCameraZoom(this.Canvas.clientWidth/e);else{let a=(o=this.Config.CameraSettings)!=null&&o.Zoom?this.Config.CameraSettings.Zoom:1;this.SetCameraZoom(a)}}CenterPage(){var a;let s=this.Sheet.Pages[0].Bounds.width+20;if(this.Canvas.clientWidth<s)this.SetCameraZoom(this.Canvas.clientWidth/s);else{let f=(a=this.Config.CameraSettings)!=null&&a.Zoom?this.Config.CameraSettings.Zoom:1;this.SetCameraZoom(f)}let o=this.Canvas.clientWidth-s*this.Camera.Zoom;this.Camera.x=o/2}AddNoteOnMeasure(e,t,i,s,o){Ie(e,t,i,s,o)}AddStaff(e,t){let i=this.Sheet.Instruments[e];if(!i)return;let s=new A(i.Staves.length);i.Staves.push(new A(i.Staves.length)),this.Sheet.Measures.filter(a=>a.Instrument===i).forEach(a=>{a.Staves.push(s),a.Clefs.push(new F(a.Clefs.length-1,t,1,s.Num)),a.Bounds.height=N(a.Staves)})}FromPitchMap(e,t){return ve(e,this.PitchMap,t)}};var y;function Zt(n,e,t){let i=e.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;n.Hover(s,o)}function zt(n,e,t){t.preventDefault();let i=e.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;t.buttons===1?n.Input(s,o,t.shiftKey):t.buttons===4&&n.SetCameraDragging(!0,s,o)}function Wt(n,e,t){let i=e.getBoundingClientRect(),s=t.clientX-i.left,o=t.clientY-i.top;n.SetCameraDragging(!1,0,0),n.StopNoteDrag(s,o)}function Xt(n,e,t){let i=t.key;n.KeyInput(i,e)}function jt(n,e){e.ctrlKey&&(e.preventDefault(),e.deltaY*-.01>0?n.AlterZoom(.05):n.AlterZoom(-.05))}function at(n,e,t,i){var s,o;t.width=i.clientWidth-50,((s=n.Config.CameraSettings)==null?void 0:s.CenterMeasures)===!0?n.CenterMeasures():(o=n.Config.CameraSettings)!=null&&o.CenterPage&&n.CenterPage(),n.AlterZoom(0),n.Update(0,0)}var rt;(c=>{function n(S,g,b,T,D,L){var U,x;let I=S.getContext("2d"),B=new fe(S,g,I,D,L);return S.addEventListener("mousemove",M=>Zt(B,S,M)),S.addEventListener("mousedown",M=>zt(B,S,M)),S.addEventListener("mouseup",M=>Wt(B,S,M)),b.addEventListener("keydown",M=>Xt(B,T,M)),window.addEventListener("resize",()=>at(B,B.Context,S,g)),S.addEventListener("wheel",M=>jt(B,M)),screen.orientation.addEventListener("change",M=>at(B,B.Context,S,g)),y=B,S.width=g.clientWidth,S.height=g.clientHeight,B.Update(0,0),(U=L.CameraSettings)!=null&&U.Zoom&&B.SetCameraZoom(L.CameraSettings.Zoom),(x=L.CameraSettings)!=null&&x.CenterMeasures&&B.CenterMeasures(),B}c.CreateApp=n;function e(){y.ChangeInputMode()}c.ChangeInputMode=e;function t(S){y.SetAccidental(S)}c.SetAccidental=t;function i(){y.Sharpen()}c.Sharpen=i;function s(){y.Flatten()}c.Flatten=s;function o(S){y.SetNoteValue(S)}c.SetNoteValue=o;function a(){y.AddMeasure()}c.AddMeasure=a;function f(S,g){y.AddStaff(S,g)}c.AddStaff=f;function r(S,g,b,T,D){y.AddNoteOnMeasure(S,g,b,T,D)}c.AddNoteOnMeasure=r;function u(){y.Delete()}c.Delete=u;function l(S){return y.SelectById(S)}c.SelectById=l;function m(){y.ToggleFormatting()}c.ToggleFormatting=m;function d(){y.Delete()}c.DeleteSelected=d;function h(S,g,b=!1){y.ChangeTimeSignature(S,g,b)}c.ChangeTimeSignature=h})(rt||(rt={}));export{fe as App,te as ClearMessage,ve as FromPitchMap,Re as GeneratePitchMap,Ve as KeyPress,st as LoadSheet,ee as MessageType,C as Note,Ni as ReturnLineFromMidi,Ne as ReturnMidiNumber,ot as SaveSheet,rt as sheet};
//# sourceMappingURL=entry.mjs.map