var b=class{constructor(e,t,n,o){this.x=e,this.y=t,this.width=n,this.height=o}IsHovered(e,t,n){return this.height<0?e>=this.x+n.x&&e<=this.x+n.x+this.width&&t>this.y-Math.abs(this.height)+n.y&&t<=this.y+n.y:e>=this.x+n.x&&e<=this.x+n.x+this.width&&t>=this.y+n.y&&t<=this.y+n.y+this.height}};var P=class{constructor(e){this.Num=e,this.Buffer=this.Num*1e3,this.TopLine=5,this.BotLine=35,this.MidLine=15}};function C(i,e=-1){let t=0;return i.forEach((n,o)=>{if(o<e||e===-1){let a=n.TopLine<0?n.BotLine+Math.abs(n.TopLine):n.BotLine-n.TopLine;t+=a*5}}),t}function Ee(i,e){let t=i.find(s=>s.Num===e);return t?(t.TopLine<0?t.BotLine+Math.abs(t.TopLine):t.BotLine-t.TopLine)*5:(console.error("Cannot find staff: ",e),-1)}function v(i,e){let n=i.find(o=>o.Num===e);return 0+(n.MidLine-n.TopLine)}var H=class{constructor(e,t){this.ID=0,this.Selected=!1,this.SelType=7,this.Bounds=new b(0,0,0,0),this.Editable=!1,this.Position=e,this.Type=t}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}};function te(i,e,t,n){if(e){if(!t){switch(e.Barlines[1].Selected&&(i.context.fillStyle="blue"),e.Barlines[1].Type){case 0:X(i,e,n,e.Barlines[1].Position);break;case 4:Ie(i,e,n);break;case 2:yt(i,e,n);break;default:X(i,e,n,e.Barlines[1].Position)}i.context.fillStyle="black";return}}else{switch(t.Barlines[0].Selected&&(i.context.fillStyle="blue"),t.Barlines[0].Type){case 0:X(i,t,n,t.Barlines[0].Position);break;case 4:Ie(i,t,n);break;default:X(i,t,n,t.Barlines[0].Position)}return}e.Barlines[1].Type==0&&t.Barlines[0].Type==0&&(e.Barlines[1].Selected||t.Barlines[0].Selected?i.context.fillStyle="blue":i.context.fillStyle="black",X(i,t,n,t.Barlines[0].Position))}function X(i,e,t,n){let s=v(e.Staves,0),a=e.Bounds.y+C(e.Staves,0)+s*5-4*5,r=e.Bounds.y+C(e.Staves,e.Staves.length-1)+s*5+4*5-a;var l=e.Bounds.x;n==1&&(l+=e.GetBoundsWithOffset().width),l=Math.floor(l);let c=`M${l+t.x}
      ${a+t.y} h
      1 v ${r} h -1 Z`;i.context.fill(new Path2D(c))}function yt(i,e,t){let o=v(e.Staves,0),s=e.Bounds.y+C(e.Staves,0)+o*5-4*5,f=e.Bounds.y+C(e.Staves,e.Staves.length-1)+o*5+4*5-s;var r=e.Bounds.x+e.GetBoundsWithOffset().width;let l=`M${r+t.x-9}
      ${s+t.y} h
      1 v ${f} h -1 Z`,c=`M${r+t.x-4}
      ${s+t.y} h
      4 v ${f+1} h -4 Z`;i.context.fill(new Path2D(l)),i.context.fill(new Path2D(c))}function Ie(i,e,t){let o=v(e.Staves,0),s=e.Bounds.y+C(e.Staves,0)+o*5-4*5,f=e.Bounds.y+C(e.Staves,e.Staves.length-1)+o*5+4*5-s;var r=e.Bounds.x+e.GetBoundsWithOffset().width;let l=`M${r+t.x-9}
      ${s+t.y} h
      1 v ${f} h -1 Z`,c=`M${r+t.x-4}
      ${s+t.y} h
      4 v ${f+1} h -4 Z`,h="a1.485 1.485 90 10-2.97 0 1.485 1.485 90 102.97 0";i.context.fill(new Path2D(l)),i.context.fill(new Path2D(c)),e.Staves.forEach(u=>{let d=v(e.Staves,u.Num),S=C(e.Staves,u.Num)+e.Bounds.y+d*5,g=`m${r-12+i.camera.x} ${S+.5+i.camera.y-5}`+h,m=`m${r-12+i.camera.x} ${S+.5+i.camera.y+5}`+h;i.context.fill(new Path2D(g)),i.context.fill(new Path2D(m))})}var ie=(s=>(s[s.None=0]="None",s[s.Selection=1]="Selection",s[s.Deletion=2]="Deletion",s[s.InputChange=3]="InputChange",s[s.AddNote=4]="AddNote",s))(ie||{});function ne(){return{messageString:"",messageData:{MessageType:0,Message:{msg:"",obj:{}}}}}var oe=40;function R(i,e,t,n,o,s){let{context:a,camera:f}=i;a.fillStyle=s?o.SelectColour:o.NoteElements,a.font=`${oe}px Bravura`,a.fillText(e,t+f.x,n+f.y)}function _(i,e,t,n,o,s,a,f){let{context:r,camera:l}=e;var c=a?s.SelectColour:s.NoteElements;i.OutOfBounds&&(c="red"),r.fillStyle=c,r.font=`${f}px Bravura`,r.fillText(t,n+l.x,o+l.y)}var G=class{constructor(e,t,n,o){this.ID=e,this.Position={x:0,y:0},this.Staff=o,this.Bounds=new b(0,0,0,0),this.Type=t,this.SelType=2,this.Beat=n,this.Selected=!1,this.Editable=!0}render(e,t){let n;switch(this.Type){case"treble":n="\u{1D11E}";break;case"bass":n="\u{1D122}";break;default:n="\u{1D11E}"}R(e,n,this.Position.x,this.Position.y,t,this.Selected)}SetBounds(e,t){let n=e.Voices[e.ActiveVoice].Divisions.find(l=>l.Beat===this.Beat&&l.Staff===t),o=this.Beat===1?e.Bounds.x:n.Bounds.x,s=3,a=2,f=0,r=v(e.Staves,t);switch(this.Position.x=o+s,this.Bounds.x=o+s,this.Type){case"bass":a=-2}this.Position.y=n.Bounds.y+f+(r+a)*5,this.Bounds.y=n.Bounds.y,this.Bounds.width=30,this.Bounds.height=85}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}};function x(i,e,t){let n=t===0?"treble":"bass";return t===0&&(i.Clefs.sort((o,s)=>o.Beat-s.Beat),i.Clefs.forEach(o=>{if(o.Beat<=e){n=o.Type;return}})),n}var K=new Map([[1,1],[.5,.5],[.25,.25],[.125,.125],[.0625,.0625],[.03125,.03125]]);function W(i){let e=i,t=[];for(i%.03125===0||console.error("Not divisible by standard value, not implemented"),K.has(i)&&(t.push(i),e-=i,e!==0&&console.error("HUH?"));e>0;){for(let[o,s]of K)K.get(o)<=e&&(t.push(K.get(o)),e-=K.get(o));e<.03125&&(e=0)}return t}var Lt="c-.2863.1212-.4577.5392-.326.8318.0397.0418.4556.5392.8736 1.0868.9551 1.0764 1.1182 1.3313 1.3292 1.8288.8339 1.7054.3762 3.877-1.0847 5.2501-.1233.163-.6625.6186-1.1683.9948-1.4525 1.2498-2.1214 1.9604-2.368 2.5874-.0899.1651-.0899.3281-.0899.581-.0397.5789 0 .6291 1.7159 2.6209 2.3262 2.7922 3.9919 4.7506 4.1215 4.8739l.1233.1212-.163-.0815c-2.2948-.9551-4.8739-1.4128-5.7475-.9948-.2947.1212-.4661.2926-.5873.5789-.3365.7106-.2466 1.7556.2529 3.2897.4556 1.3794 1.371 3.2082 2.2844 4.5813.3762.5873 1.0868 1.5006 1.1683 1.5424.1233.1233.2947.0815.4159 0 .1233-.163.1233-.2947-.1212-.5789-.8736-1.2498-1.2895-3.8372-.7921-5.2104.2027-.6186.4577-.9551.9133-1.1662 1.208-.5392 3.879.1296 4.9972 1.2477.0815.0836.2529.255.3344.2947.2947.1233.7106-.0397.8339-.3344.1714-.2947.0815-.4974-.2947-.9551-.7022-.8339-2.8257-3.3315-3.1183-3.7077-.7524-.8736-1.0868-1.7054-1.1683-2.7504-.0397-1.3313.4974-2.7421 1.5027-3.6659.1212-.163.6604-.6207 1.16-.9948 1.5424-1.2916 2.1715-2.0001 2.416-2.671.1714-.5392.0899-1.0366-.2863-1.4943-.1296-.1212-1.5842-1.9186-3.2897-3.9585-2.3345-2.7442-3.1684-3.7474-3.2897-3.7892-.1714-.0397-.3762-.0397-.5476.0418z",Mt="c-.884.1666-1.5606.7769-1.8666 1.6201-.0663.272-.0663.3383-.0663.7106 0 .5117.0323.7837.272 1.1883.3383.6783 1.0489 1.2223 1.8598 1.4212.85.2397 2.2712.034 3.8981-.5049l.4046-.1394-1.9992 5.525-1.9652 5.5182c0 0 .0663.034.1734.1071.1989.1326.5372.2329.7769.2329.4046 0 .9163-.2329.9826-.4386 0-.0663.9486-3.2878 2.0978-7.1128l2.0315-7.0125-.0663-.0986c-.1649-.2057-.5032-.272-.7106-.1071-.0663.0663-.1717.2057-.238.306-.306.5117-1.0829 1.4212-1.4875 1.7595-.3723.306-.578.3383-.9163.2057-.306-.1666-.4063-.3383-.612-1.2546-.1989-.9095-.4369-1.3226-.9486-1.6609-.4726-.3043-1.0829-.4046-1.6201-.2652z",Rt="c-.6228.1176-1.1016.5484-1.3116 1.1436-.0516.192-.0516.2388-.0516.5016 0 .3612.0228.5532.192.8388.2388.4788.7404.8628 1.3176 1.0032.5952.1692 1.5504.0468 2.7-.3324.168-.0708.3084-.1224.3084-.0984 0 .0276-1.0728 3.516-1.1196 3.6372-.1224.3096-.5304.882-.8868 1.242-.3324.3336-.5016.408-.7632.2868-.216-.1176-.2868-.24-.432-.8868-.1212-.4776-.2148-.7404-.4068-.9276-.5016-.5532-1.3644-.624-2.0304-.192-.3144.2148-.5532.5484-.6936.9096-.0516.1872-.0516.2388-.0516.5004 0 .3564.0276.5496.192.8352.2388.4776.7404.8628 1.3176 1.0032.2628.0744.9324.0744 1.3872 0 .3792-.0708.834-.1884 1.2888-.3336.192-.0696.3612-.1164.3612-.0936 0 0-2.3436 7.6272-2.3904 7.7436 0 .024.1872.1692.3792.216.192.0756.3852.0756.5772 0 .1872-.0468.3792-.1644.3792-.2388.024-.024.9804-3.6324 2.1516-8.0112l2.1288-7.9596-.0468-.0696c-.0948-.1452-.2868-.1692-.4548-.0984-.0948.0468-.0948.0468-.3804.4776-.2388.384-.576.7872-.768.9792-.2628.216-.4032.2628-.6432.1692-.2148-.1176-.2904-.2388-.4308-.8856-.1452-.642-.3144-.9336-.6708-1.1724-.3324-.2148-.7632-.2856-1.1484-.1872z",Et="m0 0c-.516.101-.918.461-1.094.957-.043.16-.043.199-.043.418 0 .218 0 .3.043.418.137.441.418.777.856.976.297.16.437.18.855.18.52 0 .957-.078 1.657-.297.179-.063.316-.102.316-.102.019 0-.16.7-.399 1.536-.296 1.175-.417 1.554-.457 1.671-.16.301-.5.758-.718.957-.2.18-.317.219-.516.141-.18-.098-.242-.199-.359-.738-.102-.399-.18-.617-.34-.778-.418-.457-1.137-.515-1.692-.156-.261.176-.46.457-.578.754-.043.16-.043.199-.043.418 0 .301.024.461.161.699.199.399.617.719 1.097.836.219.063.778.063 1.156 0 .317-.058.696-.16 1.075-.277.179-.059.32-.102.32-.102 0 .02-.797 3.051-.84 3.11-.156.34-.476.758-.715.996-.258.258-.398.301-.617.219-.18-.098-.242-.2-.359-.739-.102-.398-.18-.617-.34-.773-.418-.461-1.137-.52-1.692-.16-.261.179-.46.457-.578.758-.043.156-.043.199-.043.417 0 .219 0 .297.043.418.137.438.418.778.856.977.32.16.437.18.875.18.32 0 .422 0 .679-.043.36-.059.739-.176 1.157-.297l.258-.102v.063c-.02.078-1.696 6.375-1.715 6.414-.02.082.34.238.558.238.219 0 .539-.137.559-.238.019-.02.976-4.145 2.172-9.164 2.133-9.086 2.133-9.106 2.094-9.168-.063-.078-.161-.117-.282-.117-.14.019-.199.078-.34.316-.277.481-.597.898-.773 1.039-.121.078-.223.078-.379.02-.18-.102-.242-.2-.359-.739-.121-.539-.262-.777-.559-.976-.277-.18-.637-.238-.957-.16z",j=9;function se(i,e,t,n,o,s,a,f="black"){let{x:r,y:l,width:c,height:h}=t,{context:u,camera:d}=e;l=l+3,f=i.Editable?a.NoteElements:a.UneditableColour,f=n?a.SelectColour:f;let S=i.Grace?Math.floor(oe*.6):oe;switch(i.Duration){case .125:case .25:i.Opacity<1&&(i.Opacity+=.01),_(i,e,"\uE0A4",r,l,a,n,S);break;case .5:_(i,e,"\uE0A3",r,l,a,n,S);break;case 1:_(i,e,"\uE0A2",r-2.5,l,a,n,S);break;default:_(i,e,"\uE0A4",r,l,a,n,S)}u.fillStyle=a.NoteElements,n&&(u.fillStyle=a.SelectColour),!1&&(u.fillStyle="rgba(200, 0, 0, 0.5)",u.fillRect(r+d.x,l+d.y-5,c,h),u.fillStyle=a.NoteElements)}function Ae(i,e,t){let{context:n,camera:o}=i,s=0;switch(e.Duration){case .046875:case .09375:case .1875:case .375:case .75:case 1.5:s=1;break;case .0546875:case .109375:case .21875:case .4375:case .875:case 1.75:s=2;break;case .05859375:case .1171875:case .234375:case .46875:case .9375:case 1.875:s=3;break;default:s=0}let a="a1.485 1.485 90 10-2.97 0 1.485 1.485 90 102.97 0";for(let f=0;f<s;f++){let r=e.Line*5;e.Line%2!==0&&(r=(e.Line-1)*5);let l=`m${t+o.x+17+f*5} 
      ${r+o.y}`+a;n.fill(new Path2D(l))}}function ae(i,e,t,n,o,s){if(!n)return;i.fillStyle=s.NoteElements;let a=e.Bounds.x+t.x+j,f=o.GetNotePositionOnLine(n.Line+2.5,n.Staff)+t.y,r=`m${a} ${f}`;i.fillStyle=n.Selected?s.SelectColour:s.NoteElements,e.Duration===.3125?(f+=7,r=`m ${a} ${f}`+Et,i.fill(new Path2D(r))):e.Duration===.0625?(f+=9,r=`m ${a} ${f}`+Rt,i.fill(new Path2D(r))):e.Duration>.0625&&e.Duration<=.125?(f=f+10,r=`m${a} ${f}`+Mt,i.fill(new Path2D(r))):e.Duration===.25?(r=r+Lt,i.fill(new Path2D(r))):e.Duration===.5?(f=o.GetNotePositionOnLine(n.Line+4.5,n.Staff)+t.y,i.fillRect(a,f,14,6)):e.Duration===1&&(f=o.GetNotePositionOnLine(n.Line+3.6,n.Staff)+t.y,a=e.Bounds.x+t.x+e.Bounds.width/2-7,i.fillRect(a,f,14,6))}function It(i,e,t,n){let{context:o,camera:s}=i,a=e.x2-e.x1;o.fillStyle="#75757",o.fillRect(e.x1+s.x,e.y1-12+s.y,1,6),o.fillRect(e.x1+s.x,e.y1-12+s.y,a/2-14,1),o.fillRect(e.x1+a+s.x,e.y1-12+s.y,1,6),o.fillRect(e.x1+a/2+14+s.x,e.y1-12+s.y,a/2-14,1),R(i,xt(t),e.x1+a/2-7,e.y1-5,n,!1)}function xt(i){switch(i){case"0":return"\uE880";case"1":return"\uE881";case"2":return"\uE882";case"3":return"\uE883";case"4":return"\uE884";case"5":return"\uE885";case"6":return"\uE886";case"7":return"\uE887";case"8":return"\uE888";case"9":return"\uE889";default:return"\uE883"}}function be(i,e,t,n,o,s){let{context:a,camera:f}=i,r=e.filter(S=>S.Staff===n);r.sort((S,g)=>S.Beat-g.Beat);let l=!1,c=0,h=0,u=0,d=0;r.forEach((S,g)=>{let m=t.filter(T=>T.Beat===S.Beat&&T.Staff===n),B=[...m],D=V([m],[S]);if(!m[0].Tuple){l&&(l=!1,It(i,{x1:c,y1:u,x2:h,y2:u},d.toString(),s),c=0,h=0,u=0,d=0);return}l||(l=!0,c=S.Bounds.x+9,d=m[0].TupleDetails.Count,u=S.Bounds.y),h=S.Bounds.x+19})}function De(i,e,t,n,o){let{context:s,camera:a}=i,f=e.filter(r=>r.Staff===n);f.sort((r,l)=>r.Beat-l.Beat),f.forEach((r,l)=>{if(l===f.length-1)return;let c=t.filter(u=>u.Beat===r.Beat);c.sort((u,d)=>u.Line-d.Line);let h=t.filter(u=>u.Beat===f[l+1].Beat);h.sort((u,d)=>u.Line-d.Line),c.forEach(u=>{if(!u.Tied||u.Rest||u.Tied&&u.Beat+u.Duration*o.TimeSignature.bottom>u.TiedEnd)return;let d=h.find(M=>M.Line===u.Line&&M.Tied&&M.Beat<=M.TiedEnd);if(d===void 0){console.error("No tied note found: ",u),console.log("note: ",u),console.log(h);return}let S=d,g=r.Bounds.x+j+a.x+3,m=o.GetNotePositionOnLine(u.Line,u.Staff)+a.y-4,B=f[l+1].Bounds.x+j+a.x+3,D=o.GetNotePositionOnLine(S.Line,u.Staff)+a.y,T=B-(B-g)/2,y=B-g,w=u.Line<15?-15:15,L=u.Line<15?-8:8,p=u.Line<15?-20:20,z=u.Line<15?-17:17,ee=`
      m ${g} ${m} q ${y/2} ${p} ${y} 0 q -${y/2} ${z} -${y} 0 z
      //      `;s.fill(new Path2D(ee))})})}function V(i,e){let t=0;i.sort((f,r)=>f[0].Beat-r[0].Beat);let n=!0;if(e.forEach((f,r)=>{f.Beat!==i[r][0].Beat&&(console.error("Index: ",r),console.error("Match failed on div: ",f),console.error("Match failed on beat: ",f.Beat),console.error("Match fail note: ",i[r][0]),n=!1)}),!n){console.error("Divisions and note array do not match");return}let o=15,s=Number.MAX_SAFE_INTEGER,a=Number.MIN_SAFE_INTEGER;return i.forEach(f=>{f.forEach(r=>{r.Line<s&&(s=r.Line),r.Line>a&&(a=r.Line)})}),o-s<a-o?t=0:t=1,t}function pe(i,e,t,n,o,s,a){let{context:f,camera:r}=t,l=j,h=o.Voices[o.ActiveVoice].Notes.filter(D=>D.Beat===e.Beat&&D.Staff===e.Staff).filter(D=>D.Accidental!==0).length;h>0&&(l+=j*h-1);let u=e.Bounds.x+l-6+r.x,d="h 22 v 1.5 h-20 v-1.5 Z",S=i.filter(D=>D.Beat===e.Beat&&D.Staff===e.Staff),g=15;if(S.length===0)return;S.sort((D,T)=>D.Line-T.Line);let m=S[0],B=S[S.length-1];f.fillStyle=s.NoteElements;for(let D=g-6;D>=m.Line;D-=2){let T=o.GetNotePositionOnLine(D,n)+r.y+2.5,y=`m ${u} ${T}`+d;f.fill(new Path2D(y))}for(let D=g+6;D<=B.Line;D+=2){let T=o.GetNotePositionOnLine(D,n)+r.y+2.5,y=`m ${u} ${T}`+d;f.fill(new Path2D(y))}}var E=["A","A#","B","C","C#","D","D#","E","F","F#","G","G#"],At=new Map([["treble",16],["bass",4]]);function we(i){return Math.floor(440*Math.pow(2,(i-69)/12)*1e3)/1e3}function $i(i,e,t=0){let n=0,o=69,s=0,a=t===0?16:34,f=a;if(e===o)return a;if(e>o)for(let r=o;r<e;r++)E[n]==="C"||E[n]==="F"?(f-=0,n===0?n=E.length-1:n-=1):(f-=1,n-=1);else if(o>e)for(let r=o;r>e;r--)E[n]==="B"||E[n]==="E"?(f+=0,n===E.length-1?n=0:n+=1):(f+=1,n+=1);return f}function Pe(i,e,t=0,n=0){let o=0,s=At.get(i),a=69,f=a;if(e===s)return a+t;if(e>s)for(let r=s;r<e;r++)E[o]==="C"||E[o]==="F"?(f-=1,o-=1):(o===0?o=E.length-2:o-=2,f-=2);else for(let r=s;r>e;r--)E[o]==="B"||E[o]==="E"?(f+=1,o===E.length-1?o=0:o+=1):(f+=2,o+=2);return f+=t,f}function Ge(){let i=new Map,e=new Map,t=0,n=0,o=45,s=0,a=11;for(let f=21;f<=127;f++)t>=E.length&&(t=0,n++),o=[0,2,3,5,7,8,10].includes(s)?o-1:o,i.set((E[t]+n).toString(),we(f)),e.set(f,{NoteString:(E[t]+n).toString(),Frequency:we(f),Line:o,Accidental:E[t].includes("#")?1:0}),t++,s>=a?s=0:s++;return e}function Ve(i,e,t){let n=e.get(i),o={NoteString:n.NoteString,Line:n.Line,Frequency:n.Frequency,Accidental:n.Accidental};return t==="bass"&&(o.Line-=12),o}var N=class{constructor(e){this.Beat=e.Beat,this.Duration=e.Duration,this.Line=e.Line,this.Rest=e.Rest,this.Tied=e.Tied,this.Accidental=0,this.Staff=e.Staff,this.Clef=e.Clef,this.Grace=e.Grace,this.OutOfBounds=!1,this.Selected=!1,this.SelType=1,this.Bounds=new b(0,0,0,0),this.Bounds.width=12,this.Bounds.height=10,this.Editable=e.Editable!==void 0?e.Editable:!0,this.ID=-1,this.Tuple=e.Tuple,e.TupleDetails&&(this.TupleDetails=e.TupleDetails),this.Opacity=1}SetBounds(e){this.Bounds=e}SetID(e){this.ID=e}SetTiedStartEnd(e,t){this.TiedStart=e,this.TiedEnd=t}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}GetMidiNumber(){let e=this.Staff===0?this.Line:this.Line-1e3;return Pe(this.Clef,e,this.Staff)}};var ve=30;function Fe(i,e,t){let n=[],o=0,s=0;if(e.sort((a,f)=>a.Beat-f.Beat),e.filter(a=>a.Staff===t).length===0){let a={Beat:1,Duration:1,Line:v(i.Staves,t),Rest:!0,Tied:!1,Staff:t,Tuple:!1,Clef:t===0?"treble":"bass",Grace:!1};i.AddNote(new N(a))}return e.filter(a=>a.Staff===t).forEach(a=>{a.Beat>=i.TimeSignature.top+1?a.OutOfBounds=!0:a.OutOfBounds=!1,n.find(f=>f.Beat===a.Beat&&f.Staff===a.Staff)||(n.push(wt(i,a,t,0)),a.Tuple?o=a.Beat+a.Duration/a.TupleDetails.Count*i.TimeSignature.bottom:o=a.Beat+a.Duration*i.TimeSignature.bottom,s+=a.Duration)}),s>0&&o-1<i.TimeSignature.bottom&&Oe(i,n,t),Oe(i,n,t),n.filter(a=>a.Staff===t).forEach(a=>{Pt(a,e.filter(f=>f.Beat===a.Beat))}),A(i,t),n}function wt(i,e,t,n){var o={Beat:e.Beat,Duration:e.Duration,Bounds:Te(i,e.Beat,e.Duration,t),Staff:t,StaffGroup:e.StaffGroup,Direction:n,NoteXBuffer:0,Subdivisions:[]};return o}function Pt(i,e){i.Subdivisions=[],e.forEach(o=>{if(o.Grace&&!i.Subdivisions.find(s=>s.Type===1)){let s={Type:1,Bounds:new b(i.Bounds.x,i.Bounds.y,15,i.Bounds.height)},a={Type:1,Bounds:new b(i.Bounds.x+15,i.Bounds.y,15,i.Bounds.height)};i.Subdivisions.push(s),i.Subdivisions.push(a)}});var t=0;i.Subdivisions.forEach(o=>{t+=o.Bounds.width});let n={Type:2,Bounds:new b(i.Bounds.x+t,i.Bounds.y,i.Bounds.width-t,i.Bounds.height)};i.Subdivisions.push(n),i.Subdivisions.sort((o,s)=>s.Type-o.Type)}function Te(i,e,t,n){let o=i.Bounds.width*t,s=Ee(i.Staves,n),a=i.Bounds.x+i.XOffset+(e-1)/i.TimeSignature.bottom*i.Bounds.width,f=i.Bounds.y+C(i.Staves,n);return new b(a,f,o,s)}function He(i,e,t){let n=e.filter(o=>o.Staff===t);n.sort((o,s)=>o.Beat-s.Beat),n.forEach((o,s)=>{if(o.Bounds.width=o.Duration*i.Bounds.width,s>0){let a=n[s-1].Bounds.x+n[s-1].Bounds.width;a!==o.Bounds.x&&(o.Bounds.x=a)}s===0&&n.length===1&&(o.Bounds.width=i.Bounds.width)})}function Oe(i,e,t){let n=e.sort((u,d)=>u.Beat-d.Beat),o=1,s=[];n.filter(u=>u.Staff===t).forEach(u=>{let d=i.Voices[i.ActiveVoice].Notes.filter(S=>S.Beat===u.Beat);if(u.Beat===o)o=u.Beat+u.Duration*i.TimeSignature.bottom,d[0].Tuple&&(o=d[0].TupleDetails.EndBeat);else if(u.Beat>=o){let S=(u.Beat-o)/i.TimeSignature.bottom,g=W(S),m=o;g.sort(),g.forEach(B=>{s.push({Beat:m,Duration:B,Bounds:Te(i,m,B,u.Staff),Staff:u.Staff,StaffGroup:d[0].StaffGroup,Direction:0,NoteXBuffer:0,Subdivisions:[]}),m+=B*i.TimeSignature.bottom}),o=u.Beat+u.Duration*i.TimeSignature.bottom}}),e.push(...s),s.forEach(u=>{i.Voices[i.ActiveVoice].Notes.find(m=>m.Beat===u.Beat)!==void 0&&console.error("Note found in division gap");let S=x(i,u.Beat,t),g={Beat:u.Beat,Duration:u.Duration,Line:v(i.Staves,t),Rest:!0,Tied:!1,Staff:u.Staff,Tuple:!1,Clef:S,Grace:!1};i.AddNote(new N(g))});let a=i.TimeSignature.top/i.TimeSignature.bottom*i.TimeSignature.bottom+1,f=e.filter(u=>u.Staff===t);f=e.sort((u,d)=>u.Beat-d.Beat);let r=f[f.length-1],l=r.Beat+r.Duration*i.TimeSignature.bottom,c=[],h=a-l;if(h>0){let u=h/i.TimeSignature.bottom,d=W(u),S=l;d.sort(),d.forEach(g=>{c.push({Beat:S,Duration:g,Bounds:Te(i,S,g,r.Staff),Staff:t}),S+=g*i.TimeSignature.bottom})}e.push(...c),c.forEach(u=>{i.Voices[i.ActiveVoice].Notes.find(m=>m.Beat===u.Beat&&m.Staff===u.Staff)!==void 0&&console.error("Note found in division gap");let S=x(i,u.Beat,t),g={Beat:u.Beat,Duration:u.Duration,Line:v(i.Staves,t),Rest:!0,Tied:!1,Staff:u.Staff,Tuple:!1,Clef:S,Grace:!1};i.AddNote(new N(g))})}function ke(i,e){let t={DivGroups:[]},n=[],o=[],s=!1,a=!1,f=i.Voices[i.ActiveVoice].Divisions.filter(r=>r.Staff===e||r.StaffGroup===e).sort((r,l)=>r.Beat-l.Beat);return f.forEach(r=>{let l=i.Voices[i.ActiveVoice].Notes.filter(c=>c.Beat===r.Beat&&(c.Staff===e||c.StaffGroup===e)&&c.Grace);l.length>0&&t.DivGroups.push({Divisions:[r],Notes:[l],CrossStaff:s,Staff:e,Stems:[],Beams:[]})}),f.forEach((r,l)=>{r.Staff!==e&&(s=!0);let c=i.Voices[i.ActiveVoice].Notes.filter(u=>u.Beat===r.Beat&&(u.Staff===e||u.StaffGroup===e)&&!u.Grace);c.sort((u,d)=>u.Line-d.Line);let h=Ce(r.Beat,c,e);h&&a?(t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[],a=!1):h||(a?r.Duration>.125?(a=!1,t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[],n.push(r),o.push(c),t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[]):(r.Beat===3&&(t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[]),n.push(r),o.push(c),l===i.Voices[i.ActiveVoice].Divisions.filter(u=>u.Staff===e||u.StaffGroup===e).length-1&&(t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[])):(n.push(r),o.push(c),r.Duration>.125?(t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[]):(a=!0,l===i.Voices[i.ActiveVoice].Divisions.filter(u=>u.Staff===e||u.StaffGroup===e).length-1&&(t.DivGroups.push({Divisions:n,Notes:o,CrossStaff:s,Staff:e,Stems:[],Beams:[]}),n=[],o=[]))))}),t.DivGroups}function Ce(i,e,t){var o=!e.filter(s=>s.Beat===i&&(s.Staff===t||s.StaffGroup===t)).find(s=>!s.Rest);return o===void 0&&(o=!1),o}function Ze(i,e,t){let n=e.Divisions.sort((o,s)=>o.Beat-s.Beat);if(t===0){let o=e.Notes[0].sort((a,f)=>a.Line-f.Line)[0].Line,s=e.Notes[e.Notes.length-1].sort((a,f)=>a.Line-f.Line)[0].Line;if(o===s)return 4;if(o<s)return 2;if(o>s)return 0}else{let o=e.Notes[0].sort((a,f)=>a.Line-f.Line)[e.Notes[0].length-1].Line,s=e.Notes[e.Notes.length-1].sort((a,f)=>a.Line-f.Line)[e.Notes[e.Notes.length-1].length-1].Line;if(o===s)return 4;if(o<s)return 0;if(o>s)return 2}return 4}function $e(i,e,t,n){let o=t===0?-6:6,a=(t===0?8:-8)*n;return`M ${i.StartPoint.x+e.x+1} ${i.StartPoint.y+e.y-o+a}
        L${i.EndPoint.x+e.x+1} ${i.EndPoint.y+e.y-o+a}
        V${i.EndPoint.y+e.y+a} 
        L${i.StartPoint.x+e.x+1} ${i.StartPoint.y+e.y+a} z `}var F=class{constructor(e,t,n,o=1){this.Selected=!1;this.SelType=5;this.Editable=!1;this.Bounds=e,this.StartPoint=t,this.EndPoint=n,this.Count=o,this.ID=0}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}Render(e,t,n,o,s){e.fillStyle=s.NoteElements,this.Selected&&(e.fillStyle=s.SelectColour);let a=$e(this,t,o,0);e.fill(new Path2D(a));for(let f=1;f<this.Count;f++)e.fill(new Path2D($e(this,t,o,f)))}RenderBounds(e,t){e.strokeStyle="green",e.strokeRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height),e.stroke()}static BeamCount(e,t=!1){let n=0;return e>=.25||(e>=.03125&&e<.0625?n=3:e>=.0625&&e<.125?n=2:n=1,t&&(n-=1)),n}};function ze(i,e,t){let n=[],o=!0,s=null,a=V(i.Notes,i.Divisions);return i.Divisions.forEach((f,r)=>{if(r>e.length||e.length==0)return;let l=r==0?e[r]:e[r-1],c=e[r];if(o||F.BeamCount(f.Duration,t)!==n[n.length-1].Count&&(o=!0),o){let u=F.BeamCount(f.Duration,t);s=new F(new b(0,0,0,0),{x:l.Bounds.x,y:l.Bounds.y+l.Bounds.height},{x:c.Bounds.x,y:c.Bounds.y+c.Bounds.height},u),n.push(s),o=!1}else s.EndPoint={x:c.Bounds.x,y:c.Bounds.y+c.Bounds.height};s.Bounds.x=s.StartPoint.x+1;var h=0;s.Count>1&&(h=2*(s.Count-1)),s.Bounds.width=s.EndPoint.x-s.StartPoint.x,a==0?s.StartPoint.y>s.EndPoint.y?(s.Bounds.y=s.EndPoint.y,s.Bounds.height=s.StartPoint.y-s.EndPoint.y+6*s.Count+h):(s.Bounds.y=s.StartPoint.y,s.Bounds.height=s.EndPoint.y-s.StartPoint.y+6*s.Count+h):a===1&&(s.StartPoint.y>s.EndPoint.y?(s.Bounds.y=s.EndPoint.y-6*s.Count-h,s.Bounds.height=s.StartPoint.y-s.EndPoint.y+6*s.Count+h):(s.Bounds.y=s.StartPoint.y-6*s.Count-h,s.Bounds.height=s.EndPoint.y-s.StartPoint.y+6*s.Count+h))}),n}var Y=new Map([["CMaj/Amin",[]],["GMaj/Emin",["F#"]],["DMaj/Bmin",["F#","C#"]],["AMaj/F#min",["F#","C#","G#"]],["EMaj/C#min",["F#","C#","G#","D#"]],["BMaj/G#min",["F#","C#","G#","D#","A#"]],["F#Maj/D#min",["F#","C#","G#","D#","A#","E#"]],["C#Maj/A#min",["F#","C#","G#","D#","A#","E#","B#"]],["FMaj/Dmin",["Bb"]],["BbMaj/Gmin",["Bb","Eb"]],["EbMaj/Cmin",["Bb","Eb","Ab"]],["AbMaj/Fmin",["Bb","Eb","Ab","Db"]],["DbMaj/Bbmin",["Bb","Eb","Ab","Db","Gb"]],["GbMaj/Ebmin",["Bb","Eb","Ab","Db","Gb","Cb"]],["CbMaj/Abmin",["Bb","Eb","Ab","Db","Gb","Cb","Fb"]]]);var q=12;function Xe(i){let e=[],t=i.filter(n=>n.Accidental!==0);switch(t.sort((n,o)=>n.Line-o.Line),t.length){case 0:return[];case 1:return[q];case 2:return[q,q*2];default:Math.abs(t[0].Line-t[t.length-1].Line)>4,e=Ue(t)}return e}function Ue(i){let e=[];return i.forEach((t,n)=>{n===0?e.push(q):e.push((i.length+1-n)*q)}),e}var Ot="c-1.2495-.1955-2.5177-.1955-3.7791-.1938-.0272-.9231.1207-1.904-.2448-2.771-.2448-.5763-.7089-1.0302-1.1203-1.4977-.6579.5882-1.1985 1.3651-1.2512 2.2678-.051.6664-.0136 1.3345-.0255 2.0009-1.2614.0187-2.5347-.0425-3.7791.2057.2397-1.2376.1853-2.5024.2074-3.7553.9605-.0255 1.9873.1122 2.8798-.306.5253-.2465.9724-.6324 1.4178-.9996-.5814-.6579-1.3362-1.2376-2.2474-1.292-.6817-.0544-1.3668-.0153-2.0502-.0272-.0425-1.2444.102-2.5024-.1564-3.7315 1.2308.2227 2.4854.1649 3.7281.1819.0187.8857-.0799 1.8037.17 2.6554.1904.6511.7106 1.1526 1.1441 1.666.6137-.5338 1.1662-1.2036 1.2665-2.0417.0918-.7582.0187-1.5198.0612-2.2797 1.2529-.034 2.5432.1258 3.7553-.2703-.1802 1.2631-.1972 2.5466-.1836 3.8199-.8942.0255-1.8309-.0748-2.6809.2278-.646.2278-1.1543.7276-1.6677 1.1696.5576.5712 1.2291 1.0965 2.0587 1.1747.7616.0714 1.5266.0391 2.2899.0527.0187 1.2495-.0425 2.5109.2074 3.7434z",_e="c0 .805-.3018 1.576-1.1298 2.6109-.8772 1.0963-1.6156 1.7237-2.5886 2.4615l0-4.8049c.2212-.5586.5474-1.0108.98-1.358.4312-.3458.868-.5194 1.3104-.5194.7308 0 1.1942.4144 1.3944 1.2404.0224.0672.0336.1904.0336.3696zm-.105-3.36c-.6034 0-1.2166.1666-1.841.5012-.6244.3332-1.2152.7798-1.7724 1.3356l0-10.1804-.7882 0 0 17.4367c0 .4928.1344.7392.4032.7392.1554 0 .3485-.1302.637-.3024.8166-.4873 1.3257-.8131 1.8788-1.1567.6308-.392 1.3412-.8497 2.2806-1.7457.6482-.651 1.1172-1.3076 1.4084-1.9684.2898-.6622.4354-1.3174.4354-1.9684 0-.9632-.2562-1.6478-.7686-2.0524-.5796-.4256-1.2054-.6384-1.8732-.6384z",Ft="m0 0-.7875.2813 0-6.4406-4.5281 1.9688 0-16.7063.7594-.3375 0 6.5531 4.5563-2.0813 0 16.7625zm-.7875-9 0-4.5-3.7688 1.6594 0 4.5 3.7688-1.6594z";function Ke(i,e,t,n,o){let{context:s,camera:a}=i,f="",r="";switch(t){case 0:f=`m ${e.Bounds.x+a.x-2} ${e.Bounds.y+a.y+16}`,f+=Ft;break;case 1:R(i,"\uE262",e.Bounds.x-n,e.Bounds.y+3,o,e.Selected);break;case 2:f=`m ${e.Bounds.x+a.x-2} ${e.Bounds.y+a.y+10}`,f+=Ot;break;case-2:r=`m ${e.Bounds.x+a.x-15} ${e.Bounds.y+a.y+4}`,r+=_e;case-1:f=`m ${e.Bounds.x+a.x-5} ${e.Bounds.y+a.y+4}`,f+=_e,R(i,"\uE260",e.Bounds.x-n,e.Bounds.y+3,o,e.Selected);break;default:break}s.fillStyle="black"}function Ne(i,e,t,n,o,s,a){i.context.fillStyle="black";let f=e.Clefs.filter(c=>c.Staff===a);if(!f){console.error("(RenderKeySignature): Something went very wrong here");return}let r=f[0].Type,l=Ht(r,t);l.Lines.forEach((c,h)=>{l.Accidental==="#"?R(i,"\uE262",e.Bounds.x+o+h*10,e.GetNotePositionOnLine(c,a)+2.5,s,!1):R(i,"\uE260",e.Bounds.x+o+h*10,e.GetNotePositionOnLine(c,a)+2.5,s,!1)})}function Ht(i,e){let t={Accidental:"",Lines:[]},n=Y.get(e),o="";if(i===""||!i||!e||e==="")return console.error("ClefString or KeyString missing"),t;if(!n)return console.error("Notes undefined/null"),t;switch(n.length>0&&(n[0].includes("#")?o="#":o="b"),t.Accidental=o,i){case"bass":t.Lines=We(n,o),t.Lines=[...t.Lines.map(s=>s+=2)];break;case"treble":t.Lines=We(n,o);break;default:}return t}function We(i,e){let t=[];return e==="#"?t=[11,14,10,13,16,12,15].slice(0,i.length):t=[15,12,16,13,17,14,18].slice(0,i.length),t}var kt=new Map([["p","\uE520"],["m","\uE521"],["f","\uE522"],["r","\uE523"],["s","\uE524"],["z","\uE525"],["n","\uE526"]]),re=class{constructor(e,t,n){this.Symbol=e,this.Selected=!1,this.Staff=t,this.Beat=n,this.Bounds=new b(0,0,13*e.length,20)}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}};function je(i,e,t,n){if(t.Symbol===""){console.error("(RenderDynamic): No Symbol String");return}if(t.Staff>=e.Staves.length){console.error("(RenderDynamic): Staff out of bounds of measure");return}let o=e.Voices[e.ActiveVoice].Divisions.filter(u=>u.Beat===t.Beat);if(o.length===0){console.error("(RenderDynamic): Division Beat not matching with dynamic");return}let s=o[0],a=e.Voices[e.ActiveVoice].Notes.filter(u=>u.Beat===s.Beat).sort((u,d)=>u.Line-d.Line),f=s.Bounds.y+11*10,r=a[a.length-1].Bounds.y,c=f>r?f:r+20,h=8;t.Bounds.x=s.Bounds.x+h,t.Bounds.y=c-10;for(let u=0;u<t.Symbol.length;u++)R(i,kt.get(t.Symbol[u]),s.Bounds.x+h*(u+1)+u*5,c,n,t.Selected);$t(i,t)}function $t(i,e){i.context.strokeStyle="green",i.context.strokeRect(e.Bounds.x+i.camera.x,e.Bounds.y+i.camera.y,e.Bounds.width,e.Bounds.height),i.context.strokeStyle="black"}function Ye(i,e,t){e.render(i,t)}function qe(i,e,t){let{context:n,camera:o}=i,s=10,a=1,f=2,r=e.Staves,l=e.Bounds.y+C(r,t.Num),c=v(r,t.Num),h=C(r,r.length-2)+(v(r,r.length-1)-2)*5;for(let u=0;u<5;u++){let d=`M${e.Bounds.x+o.x} 
    ${l+5*c-s*2+s*u+o.y} h 
    ${e.Bounds.width+e.XOffset} v ${a} h -${e.Bounds.width+e.XOffset} Z`,S=new Path2D(d);n.fill(S)}}function Je(i,e,t){i.Staves.forEach(o=>qe(e,i,o)),i.RenderClef&&i.Clefs.forEach(o=>Ye(e,o,t)),i.RenderKey&&i.Staves.forEach(o=>{Ne(e,i,i.KeySignature,i.Clefs[0].Type,34,t,o.Num)}),i.RenderTimeSig&&i.TimeSignature.render(e,i,t),i.Dynamics.forEach(o=>je(e,i,o,t)),!1&&i.Voices[i.ActiveVoice].Divisions.forEach(o=>{e.context.strokeStyle="blue",e.context.strokeRect(o.Bounds.x+e.camera.x,o.Bounds.y+e.camera.y,o.Bounds.width,o.Bounds.height),o.Subdivisions.forEach((s,a)=>{a%2==0?e.context.fillStyle="rgba(0, 155, 0, 0.2)":e.context.fillStyle="rgba(255, 0, 0, 0.2)",e.context.fillRect(s.Bounds.x+e.camera.x,s.Bounds.y+e.camera.y,s.Bounds.width,s.Bounds.height),e.context.strokeStyle="blue",e.context.strokeRect(s.Bounds.x+e.camera.x,s.Bounds.y+e.camera.y,s.Bounds.width,s.Bounds.height)})})}var Qe=9;function et(i,e,t,n,o,s,a,f,r){zt(i,e,t,o,a,f,r.Theme),Je(i,e,r.Theme),i.Staves.forEach(l=>{Ut(i,e,l.Num,r.Theme),i.Voices[i.ActiveVoice].Divisions.filter(c=>c.Staff===l.Num&&c.Beat===1).forEach(c=>{i.Articulations.filter(h=>h.Beat==c.Beat&&h.Staff==c.Staff).forEach(h=>{h.Render(e,i.Voices[i.ActiveVoice].Notes.filter(u=>u.Beat==c.Beat&&u.Staff==c.Staff),i.Staves,c,r.Theme)}),e.context.fillStyle="rgba(0, 0, 0, 1)",e.context.font="12px Bravura",e.context.fillText(i.Num.toString(),i.Bounds.x+8+e.camera.x-8,i.Bounds.y+10+e.camera.y)})})}function Zt(i){if(i.Staves.length===0)return new b(0,0,0,0);let e=new b(i.Bounds.x,0,i.GetBoundsWithOffset().width,5),n=15-i.Staves[0].BotLine;return e.y=i.Bounds.y+i.GetMeasureHeight()+(n*5-2.5),e}function zt(i,e,t,n,o,s,a){let{context:f,camera:r}=e;i.Voices[i.ActiveVoice].Divisions.forEach(c=>{if(c.Bounds.IsHovered(t.x,t.y,r)){let h=i.GetLineHovered(t.y,c.Staff);if(i.Instrument.Staff===2&&(h.num=15,h.bounds=Zt(i)),h.bounds.y=i.GetNotePositionOnLine(h.num,c.Staff),n){let u={Beat:c.Beat,Duration:s,Line:h.num,Rest:o,Tied:!1,Staff:c.Staff,Tuple:!1,TupleIndex:0,TupleCount:1,Clef:"treble",Grace:!1},d=new N(u);o?ae(e.context,c,e.camera,d,i,a):(se(d,e,new b(c.Bounds.x+Qe,h.bounds.y,0,0),!0,!1,0,a),pe([d],c,e,c.Staff,i,a))}}})}function Ut(i,e,t,n){let{context:o,camera:s}=e;i.Voices[i.ActiveVoice].Divisions.filter(f=>f.Staff===t).forEach(f=>{let r=i.Voices[i.ActiveVoice].Notes.filter(l=>l.Beat===f.Beat&&l.Staff===f.Staff);if(r.sort((l,c)=>l.Line-c.Line),Ce(f.Beat,r,f.Staff)){ae(o,f,s,r[0],i,n);return}pe(i.Voices[i.ActiveVoice].Notes,f,e,t,i,n)}),i.Voices[i.ActiveVoice].DivisionGroups.forEach(f=>{if(f.Divisions.length>0){let r=V(f.Notes,f.Divisions);f.StemDir||(f.StemDir=r);let l=f.Notes[0][0].Tuple;f.Stems.forEach(c=>{c.Render(o,s,n)}),f.Beams.forEach(c=>{c.Render(o,s,F.BeamCount(f.Divisions[0].Duration,l),f.StemDir,n)}),f.Divisions.forEach(c=>{let h=!1,u=i.Voices[i.ActiveVoice].Notes.filter(d=>d.Beat===c.Beat&&d.Staff===t&&!d.Grace);u.sort((d,S)=>d.Line-S.Line),u.forEach((d,S)=>{let g=J(u,S,r);g&&(h=!0);let m=g?r===0?11:-11:0;if(d.Rest)ae(o,c,s,d,i,n);else{se(d,e,d.Bounds,d.Selected,g,r,n);let B=u.filter(T=>T.Accidental!==0);B.sort((T,y)=>T.Line-y.Line);let D=Xe(B);B.forEach((T,y)=>{Ke(e,T,T.Accidental,D[y],n)})}}),u.forEach(d=>{let S=h&&r===0?11:0;Ae(e,d,c.Bounds.x+Qe+S)})})}}),Xt(e,i,n),De(e,i.Voices[i.ActiveVoice].Divisions,i.Voices[i.ActiveVoice].Notes,0,i),be(e,i.Voices[i.ActiveVoice].Divisions,i.Voices[i.ActiveVoice].Notes,0,i,n),i.Instrument.Staff===1&&(De(e,i.Voices[i.ActiveVoice].Divisions,i.Voices[i.ActiveVoice].Notes,1,i),be(e,i.Voices[i.ActiveVoice].Divisions,i.Voices[i.ActiveVoice].Notes,1,i,n))}function Xt(i,e,t){e.Voices[e.ActiveVoice].Notes.filter(n=>n.Grace).forEach(n=>{se(n,i,n.Bounds,n.Selected,!1,0,t)})}function J(i,e,t){let n=!1,o=0,s=0,a=i[e].Line;if(i.length<=1)return!1;for(let l=e+1;l<=i.length-1;l++){if(i[l].Grace)continue;let c=i[l].Line;if(c-a===l-e||c-a===e-e)s++;else break}for(let l=e-1;l>=0;l--){if(i[l].Grace)continue;let c=i[l].Line;if(a-c===e-l||a-c===e-e)o++;else break}let f=o+s+1,r=o+1;return f%2===0?n=t===0?r%2!==0:r%2===0:n=r%2===0,n}var fe=class{constructor(e){this.Selected=!1;this.Editable=!1;this.Bounds=e}IsHovered(e,t,n){return this.Bounds.IsHovered(e,t,n)}Render(e,t,n){e.fillStyle=n.NoteElements,this.Selected&&(e.fillStyle=n.SelectColour),e.fillRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height)}RenderBounds(e,t){e.fillStyle="rgba(255, 0, 0, 255)",e.fillRect(this.Bounds.x+t.x,this.Bounds.y+t.y,this.Bounds.width,this.Bounds.height)}};function _t(i,e,t,n){return i===0&&e===0||i===1&&e===2?t-=n:(i===1&&e===0||i===0&&e===2)&&(t+=n),t}function Kt(i,e,t){return i===0?t>22:e<8}function tt(i,e,t,n){let o=[],s=9,a=V(i,e),f=Number.MAX_SAFE_INTEGER,r=Number.MIN_SAFE_INTEGER,l,c;i.forEach(S=>{S.forEach(g=>{g.Line<f&&(f=g.Line,l=g),g.Line>r&&(r=g.Line,c=g)})});let h=C(n.Staves,t)+v(n.Staves,t)*5,u=Ze(n,{Divisions:e,Notes:i,CrossStaff:!1,Staff:t,Stems:[],Beams:[]},a),d=e.length>1&&e[0].Duration<=.25;return e.forEach((S,g)=>{let m=g*(10/e.length-1),B=i[g],T=!!B[0].Grace?.6:1,y=B.filter(p=>p.Accidental!==0).length;y>0&&(s+=s*y-1),B.sort((p,z)=>p.Line-z.Line);let w=a===0?B[0].Bounds.x+10.25*T:B[0].Bounds.x+0*T;J(B,0,a)&&(w=B[0].Bounds.x+0);let L=new fe(new b(w,0,1.5,0));a===0?(L.Bounds.y=B[B.length-1].Bounds.y+2,L.Bounds.height=l.Bounds.y-B[B.length-1].Bounds.y-35):(L.Bounds.y=B[0].Bounds.y+4,L.Bounds.height=c.Bounds.y-B[0].Bounds.y+35),Kt(a,r,f)&&(L.Bounds.height=h-L.Bounds.y+n.Bounds.y),d&&(L.Bounds.height=_t(a,u,L.Bounds.height,m)),i.length>0&&i[0][0].Grace&&(L.Bounds.height*=.6,L.Bounds.width*=.6),L.Staff=t,o.push(L)}),o}var it=9;function nt(i,e,t,n,o,s){st(i,e,n,{num:t,bounds:new b(0,0,0,0)},o,s)}function ot(i,e,t,n,o,s,a){let f=!0,r=i.Voices[i.ActiveVoice].Divisions.find(c=>c.Bounds.IsHovered(t,n,o));if(!r){console.error("Beat Over Not Found");return}let l=i.GetLineHovered(n,r.Staff);i.Instrument.Staff===2&&(l.num=15),f&&st(i,e,r,l,s,a)}function st(i,e,t,n,o,s,a=1){let f=i.Voices[i.ActiveVoice].Notes.filter(u=>u.Beat===t.Beat);if(f.length<1){console.error("No notes found in division");return}let r=f[0].Tuple;r&&e!==t.Duration&&(e=e/f[0].TupleDetails.Count);let l=x(i,t.Beat,t.Staff),c={Beat:t.Beat,Duration:e,Line:n.num,Rest:o,Tied:!1,Staff:t.Staff,Tuple:r,TupleDetails:f[0].TupleDetails,Clef:l,Grace:s},h=new N(c);t.Duration===e||s?(i.ClearRestNotes(t.Beat,t.Staff),i.AddNote(h,!0)):Wt(c.Beat,c.Duration,i)&&Yt(i,c,t.Staff),ye(i),i.CreateDivisions(i.Camera),at(i)}function at(i){i.Voices[i.ActiveVoice].DivisionGroups.forEach(e=>{e.Stems=[],e.Beams=[],e.Stems.push(...tt(e.Notes,e.Divisions,e.Staff,i)),e.Beams.push(...ze(e,e.Stems,!1))})}function ye(i){var e=[];i.Staves.forEach(t=>{let n=ke(i,t.Num);e.push(...n)}),i.Voices[i.ActiveVoice].DivisionGroups=e}function A(i,e){i.Voices[i.ActiveVoice].DivisionGroups.forEach(t=>{let{Divisions:n,Notes:o}=t,s=V(o,n);n.forEach(a=>{a.Direction=s;let f=i.Voices[i.ActiveVoice].Notes.filter(u=>u.Beat===a.Beat&&u.Staff===e);f.sort((u,d)=>u.Line-d.Line);let r=it,l=f.filter(u=>u.Accidental!==0).length;l>0&&(r+=it*l-1);let c=a.Subdivisions.find(u=>u.Type===2);var h=0;c&&(h=c.Bounds.x-a.Bounds.x),a.NoteXBuffer=r+h,f.forEach((u,d)=>{let g=J(f,d,s)?s===0?11:-11:0;u.Rest||(u.Bounds.x=Math.floor(a.Bounds.x+r+h+g),u.Grace&&(u.Bounds.x-=h),u.Bounds.y=i.GetNotePositionOnLine(u.Line,u.Staff))})})}),at(i)}function Wt(i,e,t,n=1){return i*e<=t.TimeSignature.top*(1/t.TimeSignature.bottom)}function jt(i,e,t,n){let o=t.filter(a=>a.Beat===e&&a.Staff===n),s=o.find(a=>a.Rest);return s&&o.length>1?console.error("Rest found on beat with multiple notes, beat: ",e):s&&o.length===1&&i.ClearRestNotes(e,o[0].Staff),s!==void 0}function Yt(i,e,t){let n=e.Duration,o=e.Beat;e.Rest&&(e.Line=v(i.Staves,t));let s=!1,a=-1,f=-1;i.Voices[i.ActiveVoice].Divisions.filter(r=>r.Staff===t).forEach((r,l)=>{if(s&&e.Rest&&(s=!1),n>=r.Duration&&o===r.Beat){i.ClearRestNotes(o,e.Staff);let c=n,h=!1,u=0;for(let g=l;g<i.Voices[i.ActiveVoice].Divisions.length;g++){if(c<=0&&!h)continue;let m=i.Voices[i.ActiveVoice].Notes.filter(B=>B.Beat==i.Voices[i.ActiveVoice].Divisions[g].Beat);m.length>0&&m[0].Rest&&(c-=i.Voices[i.ActiveVoice].Divisions[g].Duration,c<=0&&(h=!0,u=g))}if(h){for(let B=l;B<=u;B++)i.ClearRestNotes(i.Voices[i.ActiveVoice].Divisions[B].Beat,e.Staff);let g={Beat:r.Beat,Duration:n,Line:e.Line,Rest:e.Rest,Tied:!1,Staff:r.Staff,Tuple:!1,Clef:x(i,r.Beat,r.Staff),Grace:e.Grace},m=new N(g);i.AddNote(m,!0),n=0;return}n>r.Duration&&s===!1&&!e.Rest&&(s=!0,a=r.Beat,f=r.Beat+(n-r.Duration)*i.TimeSignature.bottom);let d={Beat:r.Beat,Duration:r.Duration,Line:e.Line,Rest:e.Rest,Tied:s,Staff:r.Staff,Tuple:!1,Clef:x(i,r.Beat,r.Staff),Grace:e.Grace},S=new N(d);s&&(S.SetTiedStartEnd(a,f),n-r.Duration<=0&&(s=!1)),n-=r.Duration,o+=r.Duration*i.TimeSignature.bottom,i.AddNote(S,!0)}else if(n<r.Duration&&o===r.Beat&&n>0){let c=i.Voices[i.ActiveVoice].Notes.filter(m=>m.Beat===r.Beat&&m.Staff===r.Staff);if(jt(i,o,c,r.Staff)){let m={Beat:r.Beat,Duration:n,Line:e.Line,Rest:e.Rest,Tied:s,Staff:r.Staff,Tuple:!1,Clef:x(i,r.Beat,r.Staff),Grace:e.Grace},B=new N(m);s&&(B.SetTiedStartEnd(a,f),n-r.Duration<=0&&(s=!1)),n=0,i.AddNote(B,!0);return}let h={Beat:r.Beat,Duration:n,Line:e.Line,Rest:e.Rest,Tied:!1,Staff:r.Staff,Tuple:e.Tuple,TupleDetails:e.TupleDetails,Clef:x(i,r.Beat,r.Staff),Grace:e.Grace},u=r.Duration-n,d=W(u).sort((m,B)=>m-B),S=r.Beat,g=r.Beat+u*i.TimeSignature.bottom;c.forEach(m=>{m.Duration=n,m.Tied=!0,m.SetTiedStartEnd(S,g);let B=r.Beat+n*i.TimeSignature.bottom;d.forEach((D,T)=>{let y=T<d.length-1,w={Beat:B,Duration:D,Line:m.Line,Rest:!1,Tied:!0,Staff:m.Staff,Tuple:m.Tuple,TupleDetails:m.TupleDetails,Clef:x(i,r.Beat,r.Staff),Grace:m.Grace},L=new N(w);L.SetTiedStartEnd(S,g),i.AddNote(L,!0),B=B+D*i.TimeSignature.bottom})}),i.AddNote(new N(h),!0)}})}function rt(i,e){let t=0;for(let[n,o]of i)o.forEach(s=>{if(!(s instanceof N))return;let a=s,f=a.Duration,r=a.Duration/e;t=r;let l=a.Beat;a.Duration=r,a.Tuple=!0;let c={StartBeat:a.Beat,EndBeat:a.Beat+f*n.TimeSignature.bottom,Value:f,Count:e};a.TupleDetails=c;for(let h=1;h<e;h++){let u=new N({Beat:l+r*n.TimeSignature.bottom,Duration:r,Line:a.Line,Rest:!0,Tied:!1,Staff:a.Staff,Tuple:!0,TupleDetails:c,Clef:x(n,l+r*n.TimeSignature.bottom,a.Staff),Grace:a.Grace});l=u.Beat,n.AddNote(u,!0)}});return t}var Le=class{constructor(e,t,n=!1){this.Selected=!1,this.SelType=3,this.top=e,this.bottom=t,this.Editable=!0,this.TopPosition=[{x:0,y:0}],this.BotPosition=[{x:0,y:0}],this.Bounds=[new b(0,0,0,0)]}render(e,t,n){let o=ft(this.top),s=ft(this.bottom);t.Staves.forEach(a=>{R(e,o,this.TopPosition[a.Num].x,this.TopPosition[a.Num].y,n,this.Selected),R(e,s,this.BotPosition[a.Num].x,this.BotPosition[a.Num].y,n,this.Selected)})}SetBounds(e){this.Bounds=[],this.TopPosition=[],this.BotPosition=[],e.Staves.forEach(t=>{this.Bounds.push(new b(0,0,0,0)),this.TopPosition.push({x:0,y:0}),this.BotPosition.push({x:0,y:0});let n=e.Voices[e.ActiveVoice].Divisions.find(a=>a.Staff===t.Num);if(!n)return;let o=n.Bounds.y,s=v(e.Staves,t.Num);this.Bounds[t.Num].x=e.Bounds.x+e.XOffset-25,this.Bounds[t.Num].y=o+(s-4)*5,this.Bounds[t.Num].width=30,this.Bounds[t.Num].height=50,this.TopPosition[t.Num].x=this.Bounds[t.Num].x,this.TopPosition[t.Num].y=o+(s-2)*5,this.BotPosition[t.Num].x=this.Bounds[t.Num].x,this.BotPosition[t.Num].y=o+(s+2)*5})}IsHovered(e,t,n){return this.Bounds.filter(o=>o.IsHovered(e,t,n)).length>0}};function ft(i){let e;switch(i){case 0:e="\uE080";break;case 1:e="\uE081";break;case 2:e="\uE082";break;case 3:e="\uE083";break;case 4:e="\uE084";break;case 5:e="\uE085";break;case 6:e="\uE086";break;case 7:e="\uE087";break;case 8:e="\uE088";break;case 9:e="\uE089";break}return e}function lt(i){return new Le(i.top,i.bottom)}var $=class{constructor(){this.Notes=[],this.Divisions=[],this.DivisionGroups=[]}};var Q=class{constructor(e,t){this.ActiveVoice=0;this.Clefs=[];this.Voices=[new $,new $,new $,new $],this.Num=1,this.Staves=e.Staves,this.Message=e.Message,this.RunningID=t,this.ID=0,this.Selected=!1,this.Editable=!0,this.SelType=0,this.Instrument=e.Instrument,this.Line=0,this.Bounds=e.Bounds,this.Bounds.height=C(this.Staves),this.TimeSignature=lt(e.TimeSignature),this.KeySignature=e.KeySignature,this.Voices[this.ActiveVoice].Notes=e.Notes,this.Articulations=[],this.Dynamics=[],this.RenderClef=e.RenderClef,this.Instrument.Staff===2&&(this.RenderClef=!1),this.RenderKey=e.RenderKey,this.Camera=e.Camera,this.RenderTimeSig=e.RenderTimeSig,this.Page=e.Page,this.PageLine=e.Page.PageLines[0].Number,this.SetXOffset(),this.Barlines=e.Barlines,this.CreateDivisions(this.Camera),this.Staves.forEach((n,o)=>{let s=new G(0,e.Clefs[o].Type,1,n.Num);s.SetBounds(this,n.Num),this.Clefs.push(s)}),this.TimeSignature.SetBounds(this)}GetLineHovered(e,t){let n=this.Camera,o=e-this.Bounds.y-n.y,s=Math.floor(o/5),a=s,f=new b(this.Bounds.x,0,this.Bounds.width+this.XOffset,5),r=this.Staves.find(c=>c.Num===t),l=C(this.Staves,t)/5;return a=s+r.TopLine,f.y=this.Bounds.y+5*a,{num:a-l,bounds:f}}GetNotePositionOnLine(e,t){return C(this.Staves,t)+this.Bounds.y+(e-this.Staves[t].TopLine)*5-2.5}GetBoundsWithOffset(){return new b(this.Bounds.x,this.Bounds.y,this.Bounds.width+this.XOffset,this.Bounds.height)}SetXOffset(){this.XOffset=0,this.RenderClef&&(this.XOffset+=30),this.RenderKey&&(this.XOffset+=Y.get(this.KeySignature).length*11),this.RenderTimeSig&&(this.XOffset+=30),this.TimeSignature.SetBounds(this)}CreateDivisions(e){this.Voices[this.ActiveVoice].Divisions=[],this.Staves.forEach(t=>{this.Voices[this.ActiveVoice].Divisions.push(...Fe(this,this.Voices[this.ActiveVoice].Notes,t.Num)),He(this,this.Voices[this.ActiveVoice].Divisions,t.Num),A(this,t.Num)})}Reposition(e){this.Bounds.x=e.Bounds.x+e.Bounds.width+e.XOffset,this.CreateDivisions(this.Camera)}GetMeasureHeight(){return C(this.Staves)}AddNote(e,t=!1){if(e.Rest?this.ClearNonRestNotes(e.Beat,e.Staff):this.ClearRestNotes(e.Beat,e.Staff),e.SetID(this.RunningID.count),this.RunningID.count++,this.Voices[this.ActiveVoice].Notes.push(e),t){let n={messageString:"AddNote",messageData:{Message:{msg:"AddingNote",obj:e},MessageType:4}};this.Message(n)}}ClearNonRestNotes(e,t){for(let n=this.Voices[this.ActiveVoice].Notes.length-1;n>=0;n--)this.Voices[this.ActiveVoice].Notes[n].Beat===e&&this.Voices[this.ActiveVoice].Notes[n].Rest===!1&&this.Voices[this.ActiveVoice].Notes[n].Staff===t&&this.Voices[this.ActiveVoice].Notes.splice(n,1)}ClearRestNotes(e,t){for(let n=this.Voices[this.ActiveVoice].Notes.length-1;n>=0;n--)this.Voices[this.ActiveVoice].Notes[n].Beat===e&&this.Voices[this.ActiveVoice].Notes[n].Rest===!0&&this.Voices[this.ActiveVoice].Notes[n].Staff===t&&this.Voices[this.ActiveVoice].Notes.splice(n,1)}ClearMeasure(e){for(let t=this.Voices[this.ActiveVoice].Notes.length-1;t>=0;t--)this.Voices[this.ActiveVoice].Notes[t].Editable&&!e.includes(this.Voices[this.ActiveVoice].Notes[t])&&this.Voices[this.ActiveVoice].Notes.splice(t,1)}DeleteSelected(){for(let e=this.Voices[this.ActiveVoice].Notes.length-1;e>=0;e--)if(this.Voices[this.ActiveVoice].Notes[e].Selected&&this.Voices[this.ActiveVoice].Notes[e].Editable){let t=this.Voices[this.ActiveVoice].Notes[e].Beat,n=this.Voices[this.ActiveVoice].Notes[e].Duration,o=this.Voices[this.ActiveVoice].Notes[e].Staff,s=this.Voices[this.ActiveVoice].Notes[e].Tuple,a=this.Voices[this.ActiveVoice].Notes[e].TupleDetails;if(this.Voices[this.ActiveVoice].Notes.splice(e,1),this.Voices[this.ActiveVoice].Notes.filter(r=>r.Beat===t).length===0){let r=x(this,t,o),l={Beat:t,Duration:n,Line:v(this.Staves,o),Rest:!0,Tied:!1,Staff:o,Tuple:s,TupleDetails:a,Clef:r,Grace:!1};this.AddNote(new N(l))}}for(let e=this.Dynamics.length-1;e>=0;e--)this.Dynamics[e].Selected&&this.Dynamics.splice(e,1)}GetMinimumWidth(){return this.Voices[this.ActiveVoice].Notes.filter(n=>n.Rest!==!0).length===0?ve*4:1/this.Voices[this.ActiveVoice].Notes.sort((n,o)=>n.Duration-o.Duration)[0].Duration*ve}ReturnSelectableElements(){let e=[];return e.push(...this.Voices[this.ActiveVoice].Notes),e.push(...this.Clefs),e}IsHovered(e,t,n){return this.GetBoundsWithOffset().IsHovered(e,t,n)}ChangeTimeSignature(e,t,n){this.TimeSignature.top=e,this.TimeSignature.bottom=t}RecalculateBarlines(){this.Barlines[0].Bounds=new b(this.Bounds.x,this.Bounds.y,10,this.GetMeasureHeight()),this.Barlines[1].Bounds=new b(this.Bounds.x+this.GetBoundsWithOffset().width-10,this.Bounds.y,10,this.GetMeasureHeight())}};var Qt=5,ei=24,ti=5,ut=(ei-Qt)*ti;function ct(i,e){let t=0;if(e.DefaultStaffType)switch(e.DefaultStaffType){case"rhythm":t=2;break;case"grand":t=1;break;case"single":default:t=0}return{Position:{x:0,y:i},Staff:t,Staves:[new P(0)]}}var ht=(i,e,t,n,o,s)=>{let a=e.Staff===0?ut*2:ut,f={Instrument:e,Bounds:new b(e.Position.x,t.PageLines[0].LineBounds.y,150,a),TimeSignature:{top:4,bottom:4},KeySignature:"DMaj/Bmin",Notes:[],Clefs:[new G(0,"treble",1,0),new G(1,"bass",1,1)],Staves:[new P(0),new P(1)],RenderClef:!0,RenderTimeSig:!0,RenderKey:!0,Camera:n,Page:t,Message:o,Settings:s,Barlines:[new H(0,0),new H(1,2)]};return new Q(f,i)},le=(i,e,t,n,o,s,a,f,r,l=!1,c,h)=>{let u={Instrument:i,Bounds:e,TimeSignature:t,KeySignature:n,Notes:[],Clefs:o,Staves:s,RenderClef:l,RenderTimeSig:!1,RenderKey:!1,Camera:a,Page:r,Message:c,Settings:h,Barlines:[new H(0,0),new H(1,0)]};return new Q(u,f)};var ii={left:40,right:40,top:40,bottom:40},dt=6,ni=210*dt,oi=297*dt,ue=class{constructor(e,t,n){this.Margins=ii,this.MarginAdj=[],this.Number=n,this.Bounds=new b(e,t,ni,oi),this.MarginAdj.push({Name:"left",Direction:"horizontal",Bounds:new b(this.Bounds.x+this.Margins.left-12.5,this.Bounds.y-25,25,25)}),this.PageLines=[],this.PageLines.push({Number:1,YPos:t+this.Margins.top,LineBounds:new b(this.Bounds.x-50,t+this.Margins.top-12.5,25,25)})}AddLine(e){let t=this.PageLines[this.PageLines.length-1],n={Number:t.Number+1,YPos:this.Bounds.y+this.Margins.top,LineBounds:new b(this.Bounds.x-50,t.LineBounds.y+e-12.5,25,25)};return this.PageLines.push(n),n}};var Me=class{constructor(e){this.Instruments=e.Instruments,this.KeySignature=e.KeySignature,this.Measures=e.Measures,this.Pages=e.Pages}InputHover(e,t,n){this.Measures.forEach(o=>{o.GetBoundsWithOffset().IsHovered(e,t,n)&&o.Voices[o.ActiveVoice].Divisions.forEach(s=>{s.Bounds.IsHovered(e,t,n)&&o.Staves.forEach(a=>{A(o,a.Num)})})})}};function mt(i,e,t){var a;let n=new ue(0,0,1);(a=i.PageSettings)!=null&&a.PageWidth&&(n.Bounds.width=i.PageSettings.PageWidth);let o={Instruments:[],KeySignature:[{key:"CMaj/Amin",measureNo:0}],Measures:[],Pages:[n]},s=o.Pages[0];return o.Instruments.push(ct(20,i)),o.Measures.push(ht({count:0},o.Instruments[0],s,e,t,i.MeasureSettings)),new Me(o)}function St(i,e,t,n,o,s,a){var u;let r=i.Bounds.width,l=i.Bounds.height,c=i.Bounds.x,h=i.Bounds.y;if((u=s.PageSettings)!=null&&u.AutoSize&&(l=a[a.length-1].Bounds.y+a[a.length-1].GetMeasureHeight()+40,a.length<4&&(r=a[a.length-1].Bounds.x+a[a.length-1].GetBoundsWithOffset().width+40)),t.filter="blur(4px)",t.fillStyle=s.Theme.PageShadowColour,t.fillRect(c+n.x-4,h+n.y+4,r,l),t.filter="none",t.fillStyle=s.Theme.PageColour,t.fillRect(c+n.x,h+n.y,r,l),o){t.strokeStyle="rgba(51, 2, 16, 0.2)",t.beginPath(),t.setLineDash([10,10]),t.moveTo(c+i.Margins.left+n.x,h+n.y),t.lineTo(c+i.Margins.left+n.x,h+l+n.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(c+r-i.Margins.right+n.x,h+n.y),t.lineTo(c+r-i.Margins.right+n.x,h+l+n.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(c+n.x,h+i.Margins.top+n.y),t.lineTo(c+r+n.x,h+i.Margins.top+n.y),t.stroke(),t.beginPath(),t.setLineDash([10,10]),t.moveTo(c+n.x,h+l-i.Margins.bottom+n.y),t.lineTo(c+r+n.x,h+l-i.Margins.bottom+n.y),t.stroke(),t.strokeStyle="black";let d="rgba(51, 2, 16, 0.8)",S="rgba(2,51,16,0.8)";Z(c+i.Margins.right+n.x,h+n.y,"down",d,t),Z(c+r-i.Margins.left+n.x,h+n.y,"down",d,t),Z(c+n.x,h+i.Margins.top+n.y,"right",d,t),Z(c+r+n.x,h+i.Margins.top+n.y,"left",d,t),Z(c+n.x,h+l-i.Margins.bottom+n.y,"right",d,t),Z(c+r+n.x,h+l-i.Margins.bottom+n.y,"left",d,t),i.PageLines.forEach(g=>{Z(c+n.x-25,h+g.LineBounds.y+n.y+12.5,"right",S,t),t.strokeStyle=S,t.beginPath(),t.setLineDash([10,10]),t.moveTo(c+n.x,h+g.LineBounds.y+12.5+n.y),t.lineTo(c+r+n.x,h+g.LineBounds.y+12.5+n.y),t.stroke()}),t.strokeRect(i.MarginAdj[0].Bounds.x+n.x,i.MarginAdj[0].Bounds.y+n.y,i.MarginAdj[0].Bounds.width,i.MarginAdj[0].Bounds.height),t.stroke()}}function Z(i,e,t,n,o){switch(o.fillStyle=n,o.beginPath(),t){case"down":o.moveTo(i,e-8),o.lineTo(i-9,e-8-9*1.7),o.lineTo(i+9,e-8-9*1.7);break;case"right":o.moveTo(i-8,e),o.lineTo(i-8-9*1.7,e-9),o.lineTo(i-8-9*1.7,e+9);break;case"left":o.moveTo(i+8,e),o.lineTo(i+8+9*1.7,e-9),o.lineTo(i+8+9*1.7,e+9);break;case"up":o.moveTo(i,e+8),o.lineTo(i-9,e+8+9*1.7),o.lineTo(i+9,e+8+9*1.7);break;default:}o.fill()}var gt=(i,e,t,n,o,s,a,f,r,l,c)=>{var h,u;e.fillStyle=l.Theme.BackgroundColour,e.save(),e.setTransform(1,0,0,1,0,0),e.clearRect(0,0,i.width,i.height),(h=l.PageSettings)!=null&&h.RenderBackground&&e.fillRect(0,0,i.width,i.height),e.restore(),(u=l.PageSettings)!=null&&u.RenderPage&&n.forEach(d=>{St(d,i,e,s,r,l,t)}),e.fillStyle=l.Theme.NoteElements,t.forEach((d,S)=>{let g={canvas:i,context:e,camera:s},m=S===t.filter(B=>d.Instrument===B.Instrument).length-1;et(d,g,o,m,a,S,f,c,l),S>0&&te(g,t[S-1],d,s),te(g,null,d,s),te(g,d,null,s)})},Bt=(i,e,t,n,o,s)=>{let a={canvas:i,context:e,camera:o}};var ce=class{constructor(e,t){this.Dragging=!1,this.x=e,this.y=t,this.oldX=e,this.oldY=t,this.Zoom=1}SetDragging(e,t,n,o,s){var a;if(((a=o.CameraSettings)==null?void 0:a.DragEnabled)===!1){this.Dragging=!1;return}this.Dragging=e,this.Dragging?(this.DraggingX=t/s.Zoom,this.DraggingY=n/s.Zoom):(this.DraggingX=0,this.DraggingY=0,this.oldX=this.x,this.oldY=this.y)}DragCamera(e,t){return this.Dragging?(this.x=Math.floor(this.oldX+e-this.DraggingX),this.y=Math.floor(this.oldY+t-this.DraggingY),!0):!1}SetZoom(e){this.Zoom=e}};var de=class{constructor(){this.Measures=[],this.Clefs=[],this.Notes=new Map,this.Elements=new Map}TrySelectElement(e,t,n,o,s,a,f){let r,l=[],c=this.Elements.get(e)?this.Elements.get(e):[];return A(e,0),l.push(...e.Voices[e.ActiveVoice].Notes),l.push(...e.Clefs),e.Voices[e.ActiveVoice].DivisionGroups.forEach(h=>{l.push(...h.Stems),l.push(...h.Beams)}),l.push(...e.Barlines),l.push(...e.Dynamics),l.push(e.TimeSignature),l.forEach(h=>{if(h.IsHovered(t,n,o)&&h.Selected===!1){if(h.Selected=!0,c.push(h),h.SelType===1){let u=h,d={messageData:{MessageType:1,Message:{msg:"selected",obj:u}},messageString:"Selected Note"};if(a(d),u.Tied){let S=he(u,e);c.push(...S)}}r=h,this.Elements.set(e,c)}}),r}DeselectAllElements(e){for(let[t,n]of e)n.forEach(o=>{o.Selected=!1}),e.delete(t);return new Map}SelectElement(){return void 0}DeselectAll(){for(let[e,t]of this.Notes)t.forEach(n=>{n.Selected=!1}),this.Notes.delete(e);for(let[e,t]of this.Elements)t.forEach(n=>{n.Selected=!1}),this.Elements.delete(e)}DeselectNote(e){let t=-1;for(let[n,o]of this.Notes)o.forEach((s,a)=>{s===s&&(t=a)}),t>=0&&this.RemoveDeselected([t],n)}RemoveDeselected(e,t){e.sort();for(let n=e.length-1;n>=0;n--)this.Notes.get(t).splice(n,1);this.Notes.get(t).length===0&&this.Notes.delete(t)}SelectById(e,t){let n;return this.DeselectAll(),e.forEach(o=>{o.Voices[o.ActiveVoice].Notes.forEach(s=>{if(s.ID===t){s.Selected=!0,n=s;let a=[];a.push(s),s.Tied&&a.push(...he(s,o)),this.Elements.set(o,a)}})}),n}SelectMeasure(e){if(this.Measures.find(t=>t.ID===e.ID)){let t=this.Measures.indexOf(e);e.Selected=!1,this.Measures.splice(t,1)}else this.Measures.push(e),e.Selected=!0}SelectClef(e){if(this.Clefs.find(t=>t.ID===e.ID)){let t=this.Clefs.indexOf(e);e.Selected=!1,this.Clefs.splice(t,1)}else this.Clefs.map(t=>t.Selected=!1),this.Clefs=[],this.Clefs.push(e),e.Selected=!0}SelectNote(e,t,n,o,s){let a=!1;return e.Voices[e.ActiveVoice].Divisions.forEach(f=>{e.Voices[e.ActiveVoice].Notes.filter(l=>l.Beat===f.Beat).forEach(l=>{if(l.Bounds.IsHovered(t,n,o)){if(l.Selected=!0,this.Notes.has(e)){let h=this.Notes.get(e);h.find(u=>u===l)||(h.push(l),l.Tied&&h.push(...he(l,e)),this.Notes.set(e,h))}else{let h=[];h.push(l),l.Tied&&h.push(...he(l,e)),this.Notes.set(e,h)}a=!0}else if(l.Selected&&!s){let h=!0;l.Tied&&(h=e.Voices[e.ActiveVoice].Notes.filter(d=>d!==l&&d.Beat>=l.TiedStart&&d.Beat<=l.TiedEnd&&d.Line===l.Line&&d.Staff===l.Staff&&d.Selected===!0).length===0),h&&(this.DeselectNote(l),l.Selected=!1)}})}),!a&&!s?(this.DeselectAll(),!1):!0}};function he(i,e){let t=[],n=i.TiedStart,o=i.TiedEnd;return e.Voices[e.ActiveVoice].Notes.filter(a=>a!==i&&a.Beat>=n&&a.Beat<=o&&a.Staff===i.Staff&&a.Line===i.Line).forEach(a=>{a.Selected=!0,t.push(a)}),t}var si='{"Measures":[{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":2,"Beat":1,"Duration":0.5,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":5,"Beat":1,"Duration":0.5,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":66,"Beat":1,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":70,"Beat":1.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":71,"Beat":2,"Duration":0.125,"Line":1037,"Rest":false,"Tied":false,"Staff":1},{"ID":73,"Beat":2.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":6,"Beat":3,"Duration":0.25,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":8,"Beat":3,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":9,"Beat":3,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":74,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":77,"Beat":3.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":10,"Beat":4,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":78,"Beat":4,"Duration":0.125,"Line":1038,"Rest":false,"Tied":false,"Staff":1},{"ID":80,"Beat":4.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":100,"y":87.5,"width":263.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":17,"Beat":1,"Duration":0.25,"Line":19,"Rest":false,"Tied":false,"Staff":0},{"ID":20,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":21,"Beat":1,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":81,"Beat":1,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":84,"Beat":1.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":22,"Beat":2,"Duration":0.25,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":85,"Beat":2,"Duration":0.125,"Line":1039,"Rest":false,"Tied":false,"Staff":1},{"ID":87,"Beat":2.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":23,"Beat":3,"Duration":0.25,"Line":10,"Rest":false,"Tied":false,"Staff":0},{"ID":25,"Beat":3,"Duration":0.25,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":26,"Beat":3,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":88,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":91,"Beat":3.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":27,"Beat":4,"Duration":0.25,"Line":9,"Rest":false,"Tied":false,"Staff":0},{"ID":92,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":94,"Beat":4.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":423.3333333333333,"y":87.5,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":30,"Beat":1,"Duration":0.25,"Line":11,"Rest":false,"Tied":false,"Staff":0},{"ID":33,"Beat":1,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":34,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":95,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":99,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":35,"Beat":2,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":100,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":102,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":36,"Beat":3,"Duration":0.5,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":37,"Beat":3,"Duration":0.5,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":38,"Beat":3,"Duration":0.5,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":103,"Beat":3,"Duration":0.125,"Line":1051,"Rest":false,"Tied":false,"Staff":1},{"ID":106,"Beat":3.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":107,"Beat":4,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":109,"Beat":4.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":686.6666666666666,"y":87.5,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":41,"Beat":1,"Duration":0.25,"Line":21,"Rest":false,"Tied":false,"Staff":0},{"ID":44,"Beat":1,"Duration":0.25,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":45,"Beat":1,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":110,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":114,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":46,"Beat":2,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":115,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":117,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":52,"Beat":3,"Duration":0.25,"Line":20,"Rest":false,"Tied":false,"Staff":0},{"ID":53,"Beat":3,"Duration":0.25,"Line":19,"Rest":false,"Tied":false,"Staff":0},{"ID":118,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":121,"Beat":3.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":55,"Beat":4,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":122,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":57,"Beat":4.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":124,"Beat":4.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":100,"y":375,"width":263.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":125,"Beat":1,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":173,"Beat":1,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":129,"Beat":1.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":177,"Beat":1.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":130,"Beat":2,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":178,"Beat":2,"Duration":0.125,"Line":1037,"Rest":false,"Tied":false,"Staff":1},{"ID":180,"Beat":2.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":131,"Beat":3,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":181,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":184,"Beat":3.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":133,"Beat":4,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":185,"Beat":4,"Duration":0.125,"Line":1038,"Rest":false,"Tied":false,"Staff":1},{"ID":187,"Beat":4.5,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":423.3333333333333,"y":375,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":134,"Beat":1,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":188,"Beat":1,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":192,"Beat":1.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":137,"Beat":2,"Duration":0.25,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":193,"Beat":2,"Duration":0.125,"Line":1039,"Rest":false,"Tied":false,"Staff":1},{"ID":195,"Beat":2.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":138,"Beat":3,"Duration":0.125,"Line":10,"Rest":false,"Tied":false,"Staff":0},{"ID":196,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":141,"Beat":3.5,"Duration":0.125,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":199,"Beat":3.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":142,"Beat":4,"Duration":0.125,"Line":10,"Rest":false,"Tied":false,"Staff":0},{"ID":200,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":144,"Beat":4.5,"Duration":0.125,"Line":9,"Rest":false,"Tied":false,"Staff":0},{"ID":202,"Beat":4.5,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":686.6666666666666,"y":375,"width":263.3333333333333,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":145,"Beat":1,"Duration":0.125,"Line":11,"Rest":false,"Tied":false,"Staff":0},{"ID":203,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":149,"Beat":1.5,"Duration":0.125,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":207,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":150,"Beat":2,"Duration":0.125,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":208,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":152,"Beat":2.5,"Duration":0.125,"Line":11,"Rest":false,"Tied":false,"Staff":0},{"ID":210,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":153,"Beat":3,"Duration":0.125,"Line":12,"Rest":false,"Tied":false,"Staff":0},{"ID":211,"Beat":3,"Duration":0.125,"Line":1051,"Rest":false,"Tied":false,"Staff":1},{"ID":156,"Beat":3.5,"Duration":0.125,"Line":13,"Rest":false,"Tied":false,"Staff":0},{"ID":214,"Beat":3.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":157,"Beat":4,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":215,"Beat":4,"Duration":0.125,"Line":1042,"Rest":false,"Tied":false,"Staff":1},{"ID":159,"Beat":4.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":217,"Beat":4.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":100,"y":662.5,"width":395,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":160,"Beat":1,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":218,"Beat":1,"Duration":0.125,"Line":1050,"Rest":false,"Tied":false,"Staff":1},{"ID":164,"Beat":1.5,"Duration":0.125,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":222,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":165,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":223,"Beat":2,"Duration":0.125,"Line":1041,"Rest":false,"Tied":false,"Staff":1},{"ID":167,"Beat":2.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":225,"Beat":2.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":168,"Beat":3,"Duration":0.25,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":226,"Beat":3,"Duration":0.125,"Line":1049,"Rest":false,"Tied":false,"Staff":1},{"ID":229,"Beat":3.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":170,"Beat":4,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":230,"Beat":4,"Duration":0.125,"Line":1040,"Rest":false,"Tied":false,"Staff":1},{"ID":172,"Beat":4.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":232,"Beat":4.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":555,"y":662.5,"width":395,"height":190},"ShowClef":false,"ShowTime":false}]}',ai='{"Measures":[{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":2,"Beat":1,"Duration":0.03125,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":54,"Beat":1,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":8,"Beat":1.125,"Duration":0.03125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":9,"Beat":1.5,"Duration":0.03125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":12,"Beat":1.625,"Duration":0.03125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":13,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":58,"Beat":2,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":15,"Beat":2.5,"Duration":0.125,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":16,"Beat":3,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":60,"Beat":3,"Duration":0.125,"Line":1047,"Rest":false,"Tied":false,"Staff":1},{"ID":19,"Beat":3.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":100,"y":87.5,"width":383.3333333333333,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":22,"Beat":1,"Duration":0.0625,"Line":18,"Rest":false,"Tied":false,"Staff":0},{"ID":63,"Beat":1,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1},{"ID":27,"Beat":1.25,"Duration":0.0625,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":28,"Beat":1.5,"Duration":0.0625,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":30,"Beat":1.75,"Duration":0.0625,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":67,"Beat":2,"Duration":0.125,"Line":1048,"Rest":false,"Tied":false,"Staff":1},{"ID":69,"Beat":2.5,"Duration":0.125,"Line":1045,"Rest":false,"Tied":false,"Staff":1}],"Bounds":{"x":543.3333333333333,"y":87.5,"width":233.33333333333334,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":33,"Beat":1,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":70,"Beat":1,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":74,"Beat":1.5,"Duration":0.125,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":36,"Beat":2,"Duration":0.25,"Line":15,"Rest":false,"Tied":false,"Staff":0},{"ID":37,"Beat":3,"Duration":0.25,"Line":16,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":776.6666666666666,"y":87.5,"width":173.33333333333334,"height":190},"ShowClef":false,"ShowTime":false},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":41,"Beat":1,"Duration":0.25,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":75,"Beat":1,"Duration":0.125,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":44,"Beat":2,"Duration":0.125,"Line":16,"Rest":false,"Tied":false,"Staff":0},{"ID":89,"Beat":2,"Duration":0.25,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":46,"Beat":2.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":47,"Beat":3,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":91,"Beat":3,"Duration":0.25,"Line":1043,"Rest":false,"Tied":false,"Staff":1},{"ID":50,"Beat":3.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0},{"ID":51,"Beat":4,"Duration":0.125,"Line":17,"Rest":false,"Tied":false,"Staff":0},{"ID":92,"Beat":4,"Duration":0.25,"Line":1044,"Rest":false,"Tied":false,"Staff":1},{"ID":53,"Beat":4.5,"Duration":0.125,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":100,"y":375,"width":485,"height":190},"ShowClef":true,"ShowTime":true},{"Clef":"treble","TimeSignature":{"top":4,"bottom":4},"Notes":[{"ID":85,"Beat":1,"Duration":1,"Line":1046,"Rest":false,"Tied":false,"Staff":1},{"ID":86,"Beat":1,"Duration":1,"Line":14,"Rest":false,"Tied":false,"Staff":0}],"Bounds":{"x":645,"y":375,"width":305,"height":190},"ShowClef":false,"ShowTime":false}]}';var me=[{name:"Canon in C",file:si},{name:"Random FIle One",file:ai}];function bt(i,e,t){switch(e){case t.addmeasure:i.AddMeasure();break;case t.changeinputmode:i.ChangeInputMode();break;case t.value1:i.SetNoteValue(.03125);break;case t.value2:i.SetNoteValue(.0625);break;case t.value3:i.SetNoteValue(.125);break;case t.value4:i.SetNoteValue(.25);break;case t.value5:i.SetNoteValue(.5);break;case t.value6:i.SetNoteValue(1);break;case t.restInput:i.RestInput=!i.RestInput;break;case t.delete:i.Delete();break;case t.sharpen:i.Sharpen();break;case t.flatten:i.Flatten();break;case t.scaleToggle:break;case t.save:i.Save();break;case t.load:i.LoadSheet(me[0].file);break;case t.test_triplet:i.CreateTriplet();break;case t.debug_clear:localStorage.removeItem("persist"),localStorage.removeItem("camera_data");break;case t.beam:i.BeamSelectedNotes();break;case t.grace:i.GraceInput=!i.GraceInput;break;case t.change_timesig:i.ChangeTimeSig();break;case t.add_dynamic:i.AddDynamic("f");break;case t.cycle_voice:i.CycleActiveVoice();default:}}function pt(i,e,t,n=650){let o=e;if(!o){console.error("No page found!");return}let s=0,a=0,f=1,r=0,l=o.Bounds.width-(o.Margins.left+o.Margins.right);if(t===!1&&t!==null){i.forEach(c=>{c.PageLine=f});return}i.forEach(c=>{r++;let h=c.GetMinimumWidth()+c.XOffset;(s+h>l||r>4)&&(f++,r=1,e.PageLines.length<f&&e.AddLine(n),s=0),s+=h,c.Page=e[a],c.PageLine=f})}function Dt(i,e,t){var o,s;let n=0;return(s=(o=e.FormatSettings)==null?void 0:o.MeasureFormatSettings)!=null&&s.MaxWidth?n=e.FormatSettings.MeasureFormatSettings.MaxWidth:n=i.Bounds.width,n}function Tt(i,e,t,n){let o=e.Bounds.width-(e.Margins.left+e.Margins.right);e.PageLines.forEach(s=>{let a=i.filter(l=>l.PageLine===s.Number),f=0;a.forEach((l,c)=>{f+=l.GetMinimumWidth()+l.XOffset});let r=o-f;a.forEach((l,c)=>{if(l.Bounds.y=s.LineBounds.y,c===0){l.Bounds.x=e.Bounds.x+e.Margins.left,l.RenderClef=l.Instrument.Staff!==2,l.RenderTimeSig=!0,l.RenderKey=!0,l.SetXOffset();let u=Dt(e,n,t),d=l.GetMinimumWidth()+r/a.length,S=0;d<u?S=d:S=u,l.Bounds.width=S,l.CreateDivisions(t)}else{l.RenderClef=!1,l.RenderTimeSig=!1,l.RenderKey=!1,l.SetXOffset();let u=Dt(e,n,t),d=l.GetMinimumWidth()+r/a.length;var h=d;d>u&&(h=u),l.Bounds.width=h,a[c].Reposition(a[c-1]),l.CreateDivisions(t)}l.Clefs.forEach(u=>{u.SetBounds(l,u.Staff)}),l.TimeSignature.SetBounds(l)})})}var vt=(i,e,t,n,o,s)=>{let a={count:0};JSON.parse(o).Measures.forEach((r,l)=>{n.Staff===2&&(r.ShowClef=!1);let c=[];r.Notes.forEach((u,d)=>{let S={Beat:u.Beat,Duration:u.Duration,Line:u.Line,Rest:u.Rest,Tied:u.Tied,Staff:u.Staff,Tuple:!1,Clef:u.Clef,Editable:!0,Grace:u.Grace},g=new N(S);c.push(g)});let h=le(n,r.Bounds,r.TimeSignature,r.KeySignature,r.Clefs,r.Staves,t,a,e,r.ShowClef,s);h.Voices[h.ActiveVoice].Notes=c,i.Measures.push(h),h.CreateDivisions(t)})},Re=i=>{let e={Measures:[]};return i.Measures.forEach((t,n)=>{let o=[];t.Voices[t.ActiveVoice].Notes.forEach((s,a)=>{s.Rest||o.push({ID:s.ID,Beat:s.Beat,Duration:s.Duration,Line:s.Line,Rest:s.Rest,Tied:s.Tied,Staff:s.Staff,Clef:s.Clef,Editable:!0,Grace:s.Grace})}),e.Measures.push({Clefs:t.Clefs,Staves:t.Staves,TimeSignature:t.TimeSignature,KeySignature:t.KeySignature,Notes:o,Bounds:t.Bounds,ShowClef:t.RenderClef,ShowTime:t.RenderTimeSig})}),JSON.stringify(e)};var Se=class{constructor(e,t,n){this.Type=e,this.Beat=t,this.Staff=n}Render(e,t,n,o,s){ri(e,this.Type,o,n,t,s)}};function ri(i,e,t,n,o,s){if(o.length==1&&o[0].Rest){console.error("Trying to render accent when there are no notes");return}o.sort((h,u)=>h.Line-u.Line);var a=0;t.Direction==0?a=o[o.length-1].Bounds.y+20:a=o[0].Bounds.y-6;let f=5,r=t.Bounds.y+v(n,t.Staff)*f-4*f-6,l=t.Bounds.y+v(n,t.Staff)*f+4*f+16;a>r&&t.Direction==1?a=r:a<l&&t.Direction==0&&(a=l);var c;switch(e){case 1:t.Direction==0?c="\uE4A1":c="\uE4A0";default:c="\uE4A0"}R(i,c,t.Bounds.x+t.NoteXBuffer,a,s,!1)}var ge=class{constructor(e,t,n,o,s,a=!1){this.GraceInput=!1;var l,c;this.Config=s,this.PitchMap=Ge(),this.Message=ne(),this.NotifyCallback=o,this.Debug=!0,this.Canvas=e,this.Container=t,this.Selector=new de,this.Context=n,this.Load=a,this.RunningID={count:0},this.CamDragging=!1,this.DraggingPositions={x1:0,y1:0,x2:0,y2:0};let f=0,r=20;(l=this.Config.CameraSettings)!=null&&l.StartingPosition&&(f=this.Config.CameraSettings.StartingPosition.x,r=this.Config.CameraSettings.StartingPosition.y),this.Camera=new ce(f,r),this.Camera.Zoom=1,this.NoteValue=.5,this.StartDragY=0,this.EndDragY=0,this.DragLining=!1,this.Load||(this.Sheet=mt(this.Config,this.Camera,this.NotifyCallback)),this.NoteInput=!1,this.RestInput=!1,this.Formatting=!1,(c=this.Config.CameraSettings)!=null&&c.Zoom&&(this.Camera.Zoom=this.Config.CameraSettings.Zoom,this.SetCameraZoom(this.Camera.Zoom),this.ResizeMeasures(this.Sheet.Measures)),this.Update(0,0)}Hover(e,t){if(e=e/this.Camera.Zoom,t=t/this.Camera.Zoom,this.Camera.DragCamera(e,t)){this.Update(e,t);return}this.DraggingNote&&(this.DragNote(e,t),this.Update(e,t)),this.Formatting&&this.DragLining&&(this.DragLiner(e,t),this.Update(e,t)),this.NoteInput&&this.Sheet.InputHover(e,t,this.Camera),this.Update(e,t)}Delete(){for(let[e,t]of this.Selector.Elements)e.DeleteSelected(),e.CreateDivisions(this.Camera);this.ResizeMeasures(this.Sheet.Measures)}Input(e,t,n){e=e/this.Camera.Zoom,t=t/this.Camera.Zoom,!this.NoteInput&&this.Formatting&&this.SelectLiner(e,t);let o=this.Sheet.Measures.find(a=>a.GetBoundsWithOffset().IsHovered(e,t,this.Camera));if(o===void 0){n||(this.Selector.DeselectAll(),this.Message=ne(),this.Message.messageString="msr undefined",this.NotifyCallback(this.Message),this.Update(e,t));return}if(this.NoteInput)this.NoteInput&&(ot(o,this.NoteValue,e,t,this.Camera,this.RestInput,this.GraceInput),this.ResizeMeasures(this.Sheet.Measures.filter(a=>a.Instrument===o.Instrument)));else{n||(this.Selector.Elements=this.Selector.DeselectAllElements(this.Selector.Elements)),(this.Selector.TrySelectElement(o,e,t,this.Camera,n,this.NotifyCallback,this.Selector.Elements)===void 0&&this.Config.FormatSettings.MeasureFormatSettings.Selectable===!0||this.Config.FormatSettings.MeasureFormatSettings.Selectable===void 0)&&this.Selector.SelectMeasure(o),this.DraggingNote||(this.DraggingNote=!0);let f=o.Voices[o.ActiveVoice].Divisions.find(r=>r.Bounds.IsHovered(e,t,this.Camera));f&&(this.StartLine=o.GetLineHovered(t,f.Staff).num)}let s=Re(this.Sheet);localStorage.setItem("persist",s),localStorage.setItem("camera_data",JSON.stringify({Zoom:this.Camera.Zoom,X:this.Camera.x,Y:this.Camera.y})),this.Update(e,t)}Update(e,t){this.Render({x:e,y:t})}Render(e){gt(this.Canvas,this.Context,this.Sheet.Measures,this.Sheet.Pages,e,this.Camera,this.NoteInput,this.RestInput,this.Formatting,this.Config,this.NoteValue),this.Debug&&Bt(this.Canvas,this.Context,this.Sheet,e,this.Camera,this.Selector)}AddMeasure(){let e=this.Sheet.Measures[this.Sheet.Measures.length-1],t=0;this.Sheet.Instruments.forEach(n=>{let o=this.Sheet.Pages[0].PageLines[this.Sheet.Pages[0].PageLines.length-1],s=new b(t,o.LineBounds.y,150,e.Bounds.height),a=le(n,s,e.TimeSignature,e.KeySignature,e.Clefs,e.Staves,this.Camera,this.RunningID,this.Sheet.Pages[0],!1,this.NotifyCallback,this.Config.MeasureSettings);a.Num=this.Sheet.Measures.length+1,this.Sheet.Measures.push(a),this.ResizeMeasures(this.Sheet.Measures.filter(f=>f.Instrument===n))}),e.Barlines[1].Type==2&&(e.Barlines[1].Type=0),this.ResizeMeasures(this.Sheet.Measures)}ChangeInputMode(){this.NoteInput=!this.NoteInput}SelectLiner(e,t){let n;return this.DragLining||(this.LineNumber=-1),this.Sheet.Pages.forEach(o=>{o.PageLines.forEach(s=>{s.LineBounds.IsHovered(e,t,this.Camera)&&(n=s.LineBounds,this.DragLining||(this.StartDragY=t,this.DragLining=!0,this.LinerBounds=n,this.LineNumber=s.Number))})}),n}DragLiner(e,t){if(this.LinerBounds){this.LinerBounds.y=this.LinerBounds.y+(t-this.StartDragY);let n=this.Sheet.Pages[0];this.LinerBounds.y+12.5<=n.Bounds.y+n.Margins.top&&(this.LinerBounds.y=n.Bounds.y+n.Margins.top-12.5),this.StartDragY=t,this.Sheet.Measures.forEach(o=>{o.PageLine===this.LineNumber&&(o.Bounds.y=this.LinerBounds.y)}),this.ResizeMeasures(this.Sheet.Measures)}}DragNote(e,t){let n=this.Sheet.Measures.find(a=>a.GetBoundsWithOffset().IsHovered(e,t,this.Camera));if(n===void 0){this.DraggingNote=!1,this.StartLine=-1,this.EndLine=-1;return}let o=n.Voices[n.ActiveVoice].Divisions.find(a=>a.Bounds.IsHovered(e,t,this.Camera));o&&(this.EndLine=n.GetLineHovered(t,o.Staff).num);let s=this.EndLine-this.StartLine;for(let[a,f]of this.Selector.Elements)f.filter(r=>r.SelType===1).forEach(r=>{if(r.Selected&&r.Editable&&(r.Line+=s,A(a,r.Staff),s!==0)){let l={messageData:{MessageType:1,Message:{msg:"selected",obj:r}},messageString:"Selected Note"};this.Message=l,this.NotifyCallback(this.Message)}});this.StartLine=this.EndLine,this.ResizeMeasures(this.Sheet.Measures)}StopNoteDrag(){this.DraggingNote&&(this.StartLine=-1,this.EndLine=-1,this.DraggingNote=!1),this.DragLining&&(this.DragLining=!1)}SetCameraDragging(e,t,n){this.Camera.SetDragging(e,t,n,this.Config,this.Camera)}AlterZoom(e,t,n){let o=t/this.Camera.Zoom,s=n/this.Camera.Zoom;this.Camera.SetZoom(this.Camera.Zoom+e),this.Context.setTransform(this.Camera.Zoom,0,0,this.Camera.Zoom,0,0);let a=t/this.Camera.Zoom,f=n/this.Camera.Zoom;this.Camera.x+=a-o,this.Camera.y+=f-s,this.Camera.oldX=this.Camera.x,this.Camera.oldY=this.Camera.y,this.Update(0,0)}SetCameraZoom(e){this.Camera.SetZoom(e),this.Context.setTransform(this.Camera.Zoom,0,0,this.Camera.Zoom,0,0),this.Update(0,0)}ResizeFirstMeasure(){this.Sheet.Measures[0].CreateDivisions(this.Camera);for(let e=1;e<this.Sheet.Measures.length;e++)this.Sheet.Measures[e].Reposition(this.Sheet.Measures[e-1]);this.Update(0,0)}ResizeMeasures(e){var n,o,s;let t=(e[0].Instrument.Staff===2,400);pt(e,this.Sheet.Pages[0],(n=this.Config.PageSettings)==null?void 0:n.UsePages,t),Tt(e,this.Sheet.Pages[0],this.Camera,this.Config),(o=this.Config.CameraSettings)!=null&&o.CenterMeasures?this.CenterMeasures():(s=this.Config.CameraSettings)!=null&&s.CenterPage&&this.CenterPage(),e.forEach(a=>{ye(a),a.Staves.forEach(f=>{A(a,f.Num)}),a.RecalculateBarlines()}),this.Update(0,0)}SetNoteValue(e){this.NoteValue=e}SetAccidental(e){for(let[t,n]of this.Selector.Elements)n.forEach(o=>{if(o.SelType===1){let s=o;s.Accidental=e,this.Message=ne();let a={messageData:{MessageType:1,Message:{msg:"selected",obj:s}},messageString:"Selected Note"};this.Message=a,this.NotifyCallback(a)}});this.Update(0,0)}Sharpen(){for(let[e,t]of this.Selector.Elements)t.forEach(n=>{if(n.SelType===1){let o=n;o.Accidental+=1,o.Accidental>2&&(o.Accidental=2)}});this.Update(0,0)}Flatten(){for(let[e,t]of this.Selector.Elements)t.forEach(n=>{if(n.SelType===1){let o=n;o.Accidental-=1,o.Accidental<-2&&(o.Accidental=-2)}});this.Update(0,0)}ScaleToggle(){return this.Camera.Zoom!==1?this.Camera.Zoom=1:this.Camera.Zoom=1,this.Camera.Zoom}KeyInput(e,t){bt(this,e,t)}SelectById(e){let t=this.Selector.SelectById(this.Sheet.Measures,e);return this.Update(0,0),t}ToggleFormatting(){this.Formatting=!this.Formatting,this.Formatting&&(this.NoteInput=!1,this.RestInput=!1)}Save(){Re(this.Sheet)}LoadSheet(e){this.Sheet.Measures=[],vt(this.Sheet,this.Sheet.Pages[0],this.Camera,this.Sheet.Instruments[0],e,this.NotifyCallback),this.ResizeMeasures(this.Sheet.Measures),this.Update(0,0)}GetSaveFiles(){return me}CreateTriplet(){this.NoteValue=rt(this.Selector.Elements,3),this.ResizeMeasures(this.Sheet.Measures),this.Update(0,0)}ChangeTimeSignature(e,t,n=!1){for(let[o,s]of this.Selector.Elements)o.ChangeTimeSignature(e,t,n)}CenterMeasures(){var n,o,s;let e=100;(o=(n=this.Config.FormatSettings)==null?void 0:n.MeasureFormatSettings)!=null&&o.MaxWidth&&(e=this.Config.FormatSettings.MeasureFormatSettings.MaxWidth);let t=(this.Canvas.clientWidth-(e+e/2)*this.Camera.Zoom)/4;if(this.Camera.x=t,this.Canvas.clientWidth<e*this.Camera.Zoom)this.SetCameraZoom(this.Canvas.clientWidth/e);else{let a=(s=this.Config.CameraSettings)!=null&&s.Zoom?this.Config.CameraSettings.Zoom:1;this.SetCameraZoom(a)}}CenterPage(){var a;let o=this.Sheet.Pages[0].Bounds.width+20;if(this.Canvas.clientWidth<o)this.SetCameraZoom(this.Canvas.clientWidth/o);else{let f=(a=this.Config.CameraSettings)!=null&&a.Zoom?this.Config.CameraSettings.Zoom:1;this.SetCameraZoom(f)}let s=this.Canvas.clientWidth-o*this.Camera.Zoom;this.Camera.x=s/2,this.Camera.oldX=this.Camera.x}AddNoteOnMeasure(e,t,n,o,s){nt(e,t,n,o,s,this.GraceInput)}BeamSelectedNotes(){var e;for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach((o,s)=>{s==0&&(e=o.Staff),o.Staff!==e&&t.Voices[t.ActiveVoice].Notes.filter(a=>a.Staff==o.Staff&&a.Beat==o.Beat).forEach(a=>{a.StaffGroup=e})});this.ResizeMeasures(this.Sheet.Measures)}AddStaff(e,t){let n=this.Sheet.Instruments[e];if(!n)return;let o=new P(n.Staves.length);n.Staves.push(new P(n.Staves.length)),this.Sheet.Measures.filter(a=>a.Instrument===n).forEach(a=>{a.Staves.push(o),a.Clefs.push(new G(a.Clefs.length-1,t,1,o.Num)),a.Bounds.height=C(a.Staves)})}FromPitchMap(e,t){return Ve(e,this.PitchMap,t)}ChangeBarline(){for(let[e,t]of this.Selector.Elements)t.filter(n=>n.SelType===7).forEach(n=>{n.Position==1&&(n.Type=4)})}ChangeTimeSig(){let e=this.Sheet.Measures[0];e&&e.ChangeTimeSignature(3,4,!1)}AddDynamic(e){for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach(o=>{t.Dynamics.push(new re(e,o.Staff,o.Beat))})}AddArticulation(e){for(let[t,n]of this.Selector.Elements)n.filter(o=>o.SelType===1).forEach(o=>{t.Articulations.push(new Se(e,o.Beat,o.Staff))})}CycleActiveVoice(){this.Sheet.Measures.forEach(e=>{e.ActiveVoice+=1,e.ActiveVoice>3&&(e.ActiveVoice=0)})}};var I,fi=!1;function li(i,e,t){let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;i.Hover(o,s)}function ui(i,e,t){t.preventDefault();let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;t.buttons===1?i.Input(o,s,t.shiftKey):t.buttons===4&&i.SetCameraDragging(!0,o,s)}function ci(i,e,t){let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;i.SetCameraDragging(!1,0,0),i.StopNoteDrag()}function hi(i,e,t){let n=t.key;i.KeyInput(n,e)}function di(i,e,t){if(t.ctrlKey){let n=e.getBoundingClientRect(),o=t.clientX-n.left,s=t.clientY-n.top;t.preventDefault(),t.deltaY*-.01>0?i.AlterZoom(.075,o,s):i.AlterZoom(-.075,o,s)}}function Ct(i,e,t,n){var o,s;t.width=n.clientWidth-50,((o=i.Config.CameraSettings)==null?void 0:o.CenterMeasures)===!0?i.CenterMeasures():(s=i.Config.CameraSettings)!=null&&s.CenterPage&&i.CenterPage(),i.AlterZoom(0,0,0),i.Update(0,0)}var Nt;(g=>{function i(m,B,D,T,y,w){var z,ee;let L=m.getContext("2d"),p=new ge(m,B,L,y,w);if(m.addEventListener("mousemove",M=>li(p,m,M)),m.addEventListener("mousedown",M=>ui(p,m,M)),m.addEventListener("mouseup",M=>ci(p,m,M)),D.addEventListener("keydown",M=>hi(p,T,M)),window.addEventListener("resize",()=>Ct(p,p.Context,m,B)),m.addEventListener("wheel",M=>di(p,m,M)),screen.orientation.addEventListener("change",M=>Ct(p,p.Context,m,B)),I=p,m.width=B.clientWidth,m.height=B.clientHeight,p.Update(0,0),(z=w.CameraSettings)!=null&&z.Zoom&&p.SetCameraZoom(w.CameraSettings.Zoom),(ee=w.CameraSettings)!=null&&ee.CenterMeasures&&p.CenterMeasures(),fi){let M=localStorage.getItem("persist");if(M!==null){let Be=JSON.parse(localStorage.getItem("camera_data"));p.LoadSheet(M),p.SetCameraZoom(Be.Zoom),p.Camera.x=Be.X,p.Camera.y=Be.Y,p.ResizeMeasures(p.Sheet.Measures)}}return p}g.CreateApp=i;function e(){I.ChangeInputMode()}g.ChangeInputMode=e;function t(m){I.SetAccidental(m)}g.SetAccidental=t;function n(){I.Sharpen()}g.Sharpen=n;function o(){I.Flatten()}g.Flatten=o;function s(m){I.SetNoteValue(m)}g.SetNoteValue=s;function a(){I.AddMeasure()}g.AddMeasure=a;function f(m){I.AddArticulation(m)}g.AddArticulation=f;function r(m,B){I.AddStaff(m,B)}g.AddStaff=r;function l(m,B,D,T,y){I.AddNoteOnMeasure(m,B,D,T,y)}g.AddNoteOnMeasure=l;function c(){I.Delete()}g.Delete=c;function h(m){return I.SelectById(m)}g.SelectById=h;function u(){I.ToggleFormatting()}g.ToggleFormatting=u;function d(){I.Delete()}g.DeleteSelected=d;function S(m,B,D=!1){I.ChangeTimeSignature(m,B,D)}g.ChangeTimeSignature=S})(Nt||(Nt={}));export{ge as App,ne as ClearMessage,Ve as FromPitchMap,Ge as GeneratePitchMap,bt as KeyPress,vt as LoadSheet,ie as MessageType,N as Note,$i as ReturnLineFromMidi,Pe as ReturnMidiNumber,Re as SaveSheet,Nt as sheet};
//# sourceMappingURL=entry.mjs.map